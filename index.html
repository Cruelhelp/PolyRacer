<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>POLY RACE: Multiplayer Racing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    /* Custom Poly Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-left: 1px solid rgba(0, 255, 255, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(0, 255, 255, 0.3), rgba(0, 255, 136, 0.3));
      border-radius: 2px;
      box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, rgba(0, 255, 255, 0.5), rgba(0, 255, 136, 0.5));
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.8);
    }

    /* Firefox */
    * {
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 255, 255, 0.3) rgba(0, 0, 0, 0.3);
    }

    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      background: #000;
      font-family: 'Orbitron', sans-serif;
    }

    canvas {
      width: 100vw;
      height: 100vh;
      display: block;
      background: #000;
    }

    /* Username Modal */
    #username-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    #username-modal.hidden {
      display: none;
    }

    /* How to Play Modal */
    #howtoplay-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      overflow-y: auto;
    }

    #howtoplay-modal.visible {
      display: flex;
    }

    .howtoplay-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }

    .howtoplay-section {
      background: rgba(0, 255, 255, 0.05);
      border: 2px solid rgba(0, 255, 255, 0.3);
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .howtoplay-section:hover {
      border-color: #00ffff;
      background: rgba(0, 255, 255, 0.1);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
    }

    .howtoplay-icon {
      margin-bottom: 15px;
      display: flex;
      justify-content: center;
    }

    .howtoplay-icon svg {
      filter: drop-shadow(0 0 10px currentColor);
    }

    .howtoplay-section h3 {
      font-size: 14px;
      color: #00ffff;
      margin-bottom: 10px;
      letter-spacing: 2px;
      font-weight: 700;
    }

    .howtoplay-section p {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.5;
    }

    .modal-content {
      background: linear-gradient(135deg, #020208, #080010);
      border: 2px solid #00ffff;
      border-radius: 12px;
      padding: 40px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
      text-align: center;
    }

    .modal-title {
      font-size: 32px;
      color: #00ffff;
      margin-bottom: 10px;
      text-shadow: 0 0 20px #00ffff;
      letter-spacing: 3px;
    }

    .modal-subtitle {
      font-size: 14px;
      color: #ff00ff;
      margin-bottom: 30px;
      letter-spacing: 2px;
    }

    #username-input {
      width: 100%;
      padding: 15px;
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(0, 255, 255, 0.5);
      border-radius: 8px;
      color: #00ffff;
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      text-align: center;
      margin-bottom: 20px;
      outline: none;
      transition: all 0.3s ease;
    }

    #username-input:focus {
      border-color: #00ffff;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    }

    #username-submit {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(0, 255, 136, 0.3));
      border: 2px solid #00ffff;
      border-radius: 8px;
      color: #00ffff;
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    #username-submit:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.5), rgba(0, 255, 136, 0.5));
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    #username-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Connection Status */
    #connection-status {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid #00ffff;
      border-radius: 8px;
      padding: 12px 20px;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: #00ffff;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-dot.connected { background: #00ff88; box-shadow: 0 0 10px #00ff88; }
    .status-dot.disconnected { background: #ff0000; box-shadow: 0 0 10px #ff0000; animation: none; }
    .status-dot.connecting { background: #ff00ff; box-shadow: 0 0 10px #ff00ff; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Game HUD */
    #game-hud {
      position: fixed;
      top: 20px;
      left: 20px;
      color: #fff;
      z-index: 100;
      font-size: 14px;
    }

    .hud-item {
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 6px;
      padding: 8px 15px;
      margin-bottom: 8px;
    }

    .hud-label {
      font-size: 10px;
      color: rgba(0, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .hud-value {
      font-size: 16px;
      color: #00ffff;
      font-weight: bold;
      text-shadow: 0 0 10px #00ffff;
    }

    /* Room UI */
    #room-ui {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(2, 2, 8, 0.95);
      border: 2px solid #00ffff;
      border-radius: 12px;
      padding: 30px;
      z-index: 500;
      min-width: 400px;
      display: none;
    }

    #room-ui.visible {
      display: block;
    }

    .room-title {
      font-size: 24px;
      color: #00ffff;
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 0 0 20px #00ffff;
      letter-spacing: 2px;
    }

    .room-code {
      background: rgba(0, 255, 255, 0.1);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 6px;
      padding: 15px;
      text-align: center;
      margin-bottom: 20px;
    }

    .room-code-label {
      font-size: 10px;
      color: rgba(0, 255, 255, 0.6);
      margin-bottom: 5px;
    }

    .room-code-value {
      font-size: 28px;
      color: #00ffff;
      font-weight: bold;
      letter-spacing: 4px;
      text-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
    }

    .room-players {
      margin: 20px 0;
    }

    .room-player {
      background: rgba(0, 255, 255, 0.05);
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .room-player-name {
      color: #00ffff;
      font-size: 14px;
      font-weight: bold;
    }

    .room-player-status {
      font-size: 11px;
      padding: 4px 12px;
      border-radius: 4px;
      text-transform: uppercase;
    }

    .room-player-status.ready {
      background: rgba(0, 255, 136, 0.3);
      color: #00ff88;
      border: 1px solid #00ff88;
    }

    .room-player-status.waiting {
      background: rgba(255, 0, 255, 0.3);
      color: #ff00ff;
      border: 1px solid #ff00ff;
    }

    .room-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(0, 255, 136, 0.3));
      border: 2px solid #00ffff;
      border-radius: 8px;
      color: #00ffff;
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-top: 10px;
    }

    .room-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.5), rgba(0, 255, 136, 0.5));
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
    }

    .room-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .room-btn.secondary {
      background: linear-gradient(135deg, rgba(255, 0, 255, 0.2), rgba(138, 0, 255, 0.2));
      border-color: #ff00ff;
      color: #ff00ff;
    }

    .room-btn.secondary:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(255, 0, 255, 0.3), rgba(138, 0, 255, 0.3));
      box-shadow: 0 0 30px rgba(255, 0, 255, 0.4);
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid;
      border-radius: 8px;
      padding: 15px 30px;
      font-size: 14px;
      font-weight: bold;
      z-index: 10000;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { transform: translate(-50%, -20px); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }

    /* Customization Modal */
    #customize-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      overflow-y: auto;
    }

    #customize-modal.visible {
      display: flex;
    }

    .customize-content {
      background: linear-gradient(135deg, #020208, #080010);
      border: 2px solid #00ffff;
      border-radius: 12px;
      padding: 30px;
      max-width: 700px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
    }

    .customize-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .customize-title {
      font-size: 28px;
      color: #00ffff;
      text-shadow: 0 0 20px #00ffff;
      letter-spacing: 3px;
    }

    .customize-stats {
      background: rgba(0, 255, 255, 0.1);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 6px;
      padding: 10px 15px;
      font-size: 13px;
      color: #00ffff;
      text-align: center;
    }

    .customize-preview {
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(0, 255, 255, 0.3);
      border-radius: 8px;
      height: 150px;
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .customize-section {
      margin-bottom: 25px;
    }

    .customize-section-title {
      font-size: 16px;
      color: #ff00ff;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .customize-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 10px;
    }

    .customize-item {
      background: rgba(0, 255, 255, 0.05);
      border: 2px solid rgba(0, 255, 255, 0.2);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .customize-item.locked {
      opacity: 0.4;
      cursor: not-allowed;
      border-color: rgba(255, 0, 0, 0.3);
    }

    .customize-item.selected {
      border-color: #00ff88;
      background: rgba(0, 255, 136, 0.2);
      box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
    }

    .customize-item:not(.locked):hover {
      border-color: #00ffff;
      background: rgba(0, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    .customize-item-name {
      font-size: 13px;
      color: #00ffff;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .customize-item-req {
      font-size: 10px;
      color: rgba(255, 255, 255, 0.5);
    }

    .customize-item-icon {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .customize-item.color-item {
      height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .customize-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .customize-btn {
      flex: 1;
      padding: 15px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(0, 255, 136, 0.3));
      border: 2px solid #00ffff;
      border-radius: 8px;
      color: #00ffff;
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .customize-btn:hover {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.5), rgba(0, 255, 136, 0.5));
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
    }

    .customize-btn.secondary {
      background: linear-gradient(135deg, rgba(255, 0, 255, 0.2), rgba(138, 0, 255, 0.2));
      border-color: #ff00ff;
      color: #ff00ff;
    }

    .customize-btn.secondary:hover {
      background: linear-gradient(135deg, rgba(255, 0, 255, 0.3), rgba(138, 0, 255, 0.3));
      box-shadow: 0 0 30px rgba(255, 0, 255, 0.4);
    }

    /* Dashboard */
    #dashboard {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      display: none;
      z-index: 5000;
    }

    #dashboard.visible {
      display: flex;
    }

    .dashboard-container {
      display: flex;
      width: 100%;
      height: 100%;
    }

    .dashboard-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 40px;
      overflow-y: auto;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }

    .dashboard-title {
      font-size: 32px;
      font-weight: 900;
      color: #00ffff;
      text-shadow: 0 0 20px #00ffff;
      letter-spacing: 4px;
    }

    .dashboard-player-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .player-preview-container {
      background: rgba(0, 255, 255, 0.05);
      border: 2px solid rgba(0, 255, 255, 0.3);
      border-radius: 12px;
      padding: 20px;
      width: 150px;
      height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .player-preview-canvas {
      width: 100%;
      height: 100%;
    }

    .player-stats {
      text-align: left;
    }

    .player-name-display {
      font-size: 20px;
      color: #00ffff;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .player-stat {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      margin: 5px 0;
    }

    .dashboard-menu {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .menu-card {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.05), rgba(0, 255, 136, 0.05));
      border: 2px solid rgba(0, 255, 255, 0.3);
      border-radius: 12px;
      padding: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .menu-card:hover {
      border-color: #00ffff;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.15), rgba(0, 255, 136, 0.15));
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
      transform: translateY(-5px);
    }

    .menu-card-icon {
      width: 60px;
      height: 60px;
      margin: 0 auto 15px;
    }

    .menu-card-title {
      font-size: 20px;
      color: #00ffff;
      font-weight: bold;
      margin-bottom: 10px;
      letter-spacing: 2px;
    }

    .menu-card-desc {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
      line-height: 1.5;
    }

    /* Chat Panel */
    .dashboard-chat {
      width: 350px;
      background: rgba(0, 0, 0, 0.8);
      border-left: 2px solid rgba(0, 255, 255, 0.2);
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 20px;
      border-bottom: 1px solid rgba(0, 255, 255, 0.2);
    }

    .chat-title {
      font-size: 18px;
      color: #00ffff;
      font-weight: bold;
      letter-spacing: 2px;
    }

    .chat-online {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 5px;
    }

    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .chat-message {
      background: rgba(0, 255, 255, 0.05);
      border-left: 3px solid rgba(0, 255, 255, 0.3);
      padding: 10px;
      border-radius: 4px;
    }

    .chat-message-user {
      font-size: 12px;
      color: #00ffff;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .chat-message-text {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.8);
      word-wrap: break-word;
    }

    .chat-message-time {
      font-size: 10px;
      color: rgba(255, 255, 255, 0.4);
      margin-top: 5px;
    }

    .chat-input-container {
      padding: 20px;
      border-top: 1px solid rgba(0, 255, 255, 0.2);
    }

    .chat-input {
      width: 100%;
      padding: 12px;
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(0, 255, 255, 0.3);
      border-radius: 6px;
      color: #fff;
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      outline: none;
      transition: all 0.3s ease;
    }

    .chat-input:focus {
      border-color: #00ffff;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
    }
  </style>
</head>
<body>
  <!-- Username Modal -->
  <div id="username-modal">
    <div class="modal-content">
      <div class="modal-title">POLY RACE</div>
      <div class="modal-subtitle">ENTER YOUR NAME</div>
      <input type="text" id="username-input" placeholder="Your Username" maxlength="15" autocomplete="off">
      <button id="username-submit">START RACING</button>
    </div>
  </div>

  <!-- How to Play Modal -->
  <div id="howtoplay-modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-title">HOW TO PLAY</div>
      <div class="howtoplay-content">
        <div class="howtoplay-section">
          <div class="howtoplay-icon">
            <svg viewBox="0 0 60 60" width="50" height="50">
              <rect x="15" y="20" width="30" height="20" fill="none" stroke="#00ffff" stroke-width="2" rx="3"/>
              <text x="30" y="35" text-anchor="middle" fill="#00ffff" font-size="16" font-weight="bold" font-family="Orbitron">A</text>
            </svg>
          </div>
          <h3>TYPE TO RACE</h3>
          <p>Type the letters above your character to move forward</p>
        </div>

        <div class="howtoplay-section">
          <div class="howtoplay-icon">
            <svg viewBox="0 0 60 60" width="50" height="50">
              <path d="M 10 30 L 30 10 L 50 30 L 40 30 L 40 50 L 20 50 L 20 30 Z" fill="none" stroke="#00ff88" stroke-width="2"/>
            </svg>
          </div>
          <h3>SPEED & ACCURACY</h3>
          <p>Faster typing = faster speed. Keep combo high for boost</p>
        </div>

        <div class="howtoplay-section">
          <div class="howtoplay-icon">
            <svg viewBox="0 0 60 60" width="50" height="50">
              <path d="M 20 15 L 30 5 L 40 15 L 35 15 L 35 35 L 25 35 L 25 15 Z" fill="none" stroke="#FFD700" stroke-width="2"/>
              <rect x="15" y="35" width="30" height="8" fill="none" stroke="#FFD700" stroke-width="2"/>
            </svg>
          </div>
          <h3>WIN RACES</h3>
          <p>First to finish wins. Unlock items with wins</p>
        </div>

        <div class="howtoplay-section">
          <div class="howtoplay-icon">
            <svg viewBox="0 0 60 60" width="50" height="50">
              <circle cx="20" cy="25" r="8" fill="none" stroke="#00ffff" stroke-width="2"/>
              <circle cx="40" cy="25" r="8" fill="none" stroke="#ff00ff" stroke-width="2"/>
              <line x1="25" y1="25" x2="35" y2="25" stroke="#00ff88" stroke-width="2"/>
            </svg>
          </div>
          <h3>LOCAL MODE</h3>
          <p>Player 1: ASDF keys | Player 2: JKL; keys</p>
        </div>
      </div>
      <button id="close-howtoplay-btn" style="width: 100%; padding: 15px; background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(0, 255, 136, 0.3)); border: 2px solid #00ffff; border-radius: 8px; color: #00ffff; font-family: 'Orbitron', sans-serif; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px;">GOT IT</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard">
    <div class="dashboard-container">
      <div class="dashboard-main">
        <div class="dashboard-header">
          <div class="dashboard-title">POLY RACE</div>
          <div class="dashboard-player-info">
            <div class="player-preview-container">
              <canvas id="dashboard-player-preview" width="120" height="120"></canvas>
            </div>
            <div class="player-stats">
              <div class="player-name-display" id="dashboard-player-name">---</div>
              <div class="player-stat"><strong id="dashboard-wins">0</strong> Wins</div>
              <div class="player-stat"><strong id="dashboard-games">0</strong> Games Played</div>
            </div>
          </div>
        </div>

        <div class="dashboard-menu">
          <div class="menu-card" id="menu-local">
            <div class="menu-card-icon">
              <svg viewBox="0 0 60 60" width="60" height="60">
                <circle cx="30" cy="25" r="10" fill="none" stroke="#00ff88" stroke-width="2"/>
                <path d="M 15 45 Q 30 38 45 45" fill="none" stroke="#00ff88" stroke-width="2"/>
                <polygon points="15,10 25,5 25,15" fill="none" stroke="#00ff88" stroke-width="2"/>
              </svg>
            </div>
            <div class="menu-card-title">LOCAL</div>
            <div class="menu-card-desc">Practice offline</div>
          </div>

          <div class="menu-card" id="menu-multiplayer">
            <div class="menu-card-icon">
              <svg viewBox="0 0 60 60" width="60" height="60">
                <circle cx="20" cy="25" r="8" fill="none" stroke="#00ffff" stroke-width="2"/>
                <path d="M 10 42 Q 20 38 30 42" fill="none" stroke="#00ffff" stroke-width="2"/>
                <circle cx="40" cy="25" r="8" fill="none" stroke="#ff00ff" stroke-width="2"/>
                <path d="M 30 42 Q 40 38 50 42" fill="none" stroke="#ff00ff" stroke-width="2"/>
                <line x1="25" y1="25" x2="35" y2="25" stroke="#00ff88" stroke-width="2"/>
              </svg>
            </div>
            <div class="menu-card-title">ONLINE</div>
            <div class="menu-card-desc">Race against players</div>
          </div>

          <div class="menu-card" id="menu-customize">
            <div class="menu-card-icon">
              <svg viewBox="0 0 60 60" width="60" height="60">
                <circle cx="30" cy="20" r="10" fill="none" stroke="#00ffff" stroke-width="2"/>
                <path d="M 15 45 Q 30 38 45 45" fill="none" stroke="#00ffff" stroke-width="2"/>
                <path d="M 20 28 L 25 35" stroke="#ff00ff" stroke-width="2"/>
                <path d="M 40 28 L 35 35" stroke="#ff00ff" stroke-width="2"/>
              </svg>
            </div>
            <div class="menu-card-title">CUSTOMIZE</div>
            <div class="menu-card-desc">Personalize your character</div>
          </div>

          <div class="menu-card" id="menu-settings">
            <div class="menu-card-icon">
              <svg viewBox="0 0 60 60" width="60" height="60">
                <circle cx="30" cy="30" r="15" fill="none" stroke="#00ffff" stroke-width="2"/>
                <circle cx="30" cy="30" r="8" fill="none" stroke="#00ffff" stroke-width="2"/>
                <line x1="30" y1="10" x2="30" y2="18" stroke="#ff00ff" stroke-width="2"/>
                <line x1="30" y1="42" x2="30" y2="50" stroke="#ff00ff" stroke-width="2"/>
                <line x1="10" y1="30" x2="18" y2="30" stroke="#ff00ff" stroke-width="2"/>
                <line x1="42" y1="30" x2="50" y2="30" stroke="#ff00ff" stroke-width="2"/>
              </svg>
            </div>
            <div class="menu-card-title">SETTINGS</div>
            <div class="menu-card-desc">Adjust game preferences</div>
          </div>

          <div class="menu-card" id="menu-howtoplay">
            <div class="menu-card-icon">
              <svg viewBox="0 0 60 60" width="60" height="60">
                <circle cx="30" cy="30" r="20" fill="none" stroke="#00ffff" stroke-width="2"/>
                <path d="M 25 22 Q 30 18 35 22" fill="none" stroke="#ff00ff" stroke-width="2"/>
                <line x1="30" y1="25" x2="30" y2="35" stroke="#ff00ff" stroke-width="2"/>
                <circle cx="30" cy="40" r="2" fill="#ff00ff"/>
              </svg>
            </div>
            <div class="menu-card-title">HOW TO PLAY</div>
            <div class="menu-card-desc">Learn the game mechanics</div>
          </div>
        </div>
      </div>

      <div class="dashboard-chat">
        <div class="chat-header">
          <div class="chat-title">GLOBAL CHAT</div>
          <div class="chat-online"><span id="chat-online-count">0</span> players online</div>
        </div>
        <div class="chat-messages" id="chat-messages">
          <div class="chat-message">
            <div class="chat-message-user">System</div>
            <div class="chat-message-text">Welcome to Poly Race! Say hi to other players.</div>
            <div class="chat-message-time">Just now</div>
          </div>
        </div>
        <div class="chat-input-container">
          <input type="text" class="chat-input" id="chat-input" placeholder="Type a message..." maxlength="200">
        </div>
      </div>
    </div>
  </div>

  <!-- Connection Status -->
  <div id="connection-status">
    <div class="status-dot connecting"></div>
    <span id="connection-text">Connecting...</span>
  </div>

  <!-- Game HUD -->
  <div id="game-hud" style="display: none;">
    <div class="hud-item">
      <div class="hud-label">Your Name</div>
      <div class="hud-value" id="hud-player-name">---</div>
    </div>
    <div class="hud-item">
      <div class="hud-label">Room Code</div>
      <div class="hud-value" id="hud-room-code">---</div>
    </div>
  </div>

  <!-- Room UI -->
  <div id="room-ui">
    <div class="room-title" id="room-title">WAITING FOR PLAYERS</div>

    <div class="room-code">
      <div class="room-code-label">ROOM CODE</div>
      <div class="room-code-value" id="display-room-code">------</div>
    </div>

    <div class="room-players" id="room-players-list">
      <!-- Players will be added here dynamically -->
    </div>

    <button class="room-btn" id="ready-btn">I'M READY</button>
    <button class="room-btn secondary" id="leave-room-btn">LEAVE ROOM</button>
  </div>

  <!-- Customization Modal -->
  <div id="customize-modal">
    <div class="customize-content">
      <div class="customize-header">
        <div class="customize-title">CUSTOMIZE</div>
        <div class="customize-stats">
          <div><strong id="wins-display">0</strong> Wins</div>
          <div><strong id="games-display">0</strong> Games</div>
        </div>
      </div>

      <div class="customize-preview">
        <canvas id="preview-canvas" width="400" height="150"></canvas>
      </div>

      <div class="customize-section">
        <div class="customize-section-title">Gender</div>
        <div class="customize-grid" id="gender-grid"></div>
      </div>

      <div class="customize-section">
        <div class="customize-section-title">Primary Color</div>
        <div class="customize-grid" id="colors-grid"></div>
      </div>

      <div class="customize-section">
        <div class="customize-section-title">Body Type</div>
        <div class="customize-grid" id="body-shapes-grid"></div>
      </div>

      <div class="customize-section">
        <div class="customize-section-title">Head Shape</div>
        <div class="customize-grid" id="head-shapes-grid"></div>
      </div>

      <div class="customize-section">
        <div class="customize-section-title">Hats</div>
        <div class="customize-grid" id="hats-grid"></div>
      </div>

      <div class="customize-section">
        <div class="customize-section-title">Necklaces</div>
        <div class="customize-grid" id="necklaces-grid"></div>
      </div>

      <div class="customize-section">
        <div class="customize-section-title">Armor</div>
        <div class="customize-grid" id="armor-grid"></div>
      </div>

      <div class="customize-section">
        <div class="customize-section-title">Special Effects</div>
        <div class="customize-grid" id="accessories-grid"></div>
      </div>

      <div class="customize-actions">
        <button class="customize-btn" id="apply-customize-btn">APPLY</button>
        <button class="customize-btn secondary" id="close-customize-btn">CLOSE</button>
      </div>
    </div>
  </div>

  <!-- Quit Button (appears during gameplay) -->
  <button id="quit-game-btn" style="display: none; position: fixed; top: 20px; right: 20px; background: rgba(255, 0, 0, 0.3); border: 2px solid #ff0000; border-radius: 8px; padding: 10px 20px; color: #ff0000; font-family: 'Orbitron', sans-serif; font-size: 14px; font-weight: bold; cursor: pointer; z-index: 9000; transition: all 0.3s ease;">
    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 5px;">
      <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4M10 17l5-5-5-5M13.8 12H3"/>
    </svg>
    QUIT
  </button>

  <canvas id="game-canvas"></canvas>

  <script>
    // =======================================
    // GAME STATE & SOCKET CONNECTION
    // =======================================
    let socket = null;
    let myPlayerId = null;
    let myPlayerName = null;
    let currentRoom = null;
    let gameState = 'menu'; // menu, waiting, countdown, playing, finished

    // =======================================
    // CUSTOMIZATION SYSTEM
    // =======================================
    let myCustomization = {
      gender: 'male',
      bodyShape: 'athletic',
      headShape: 'round',
      skinColor: '#ffcc99',
      primaryColor: '#00ffff',
      secondaryColor: '#0088ff',
      trail: false,
      aura: false,
      cape: false,
      hat: '',
      necklace: '',
      visor: false,
      armor: ''
    };

    let opponentCustomization = null;
    let playerStats = {
      wins: 0,
      gamesPlayed: 0
    };

    const UNLOCKABLES = {
      genders: [
        { id: 'male', name: 'Male', requirement: 0 },
        { id: 'female', name: 'Female', requirement: 0 }
      ],
      colors: [
        { id: 'cyan', value: '#00ffff', name: 'Cyan', requirement: 0 },
        { id: 'magenta', value: '#ff00ff', name: 'Magenta', requirement: 1 },
        { id: 'green', value: '#00ff88', name: 'Green', requirement: 3 },
        { id: 'purple', value: '#8800ff', name: 'Purple', requirement: 10 },
        { id: 'yellow', value: '#ffff00', name: 'Yellow', requirement: 15 },
        { id: 'orange', value: '#ff8800', name: 'Orange', requirement: 25 },
        { id: 'red', value: '#ff0044', name: 'Red', requirement: 35 },
        { id: 'white', value: '#ffffff', name: 'White', requirement: 50 }
      ],
      bodyShapes: [
        { id: 'athletic', name: 'Athletic', requirement: 0 },
        { id: 'muscular', name: 'Muscular', requirement: 5 },
        { id: 'slim', name: 'Slim', requirement: 10 },
        { id: 'bulky', name: 'Bulky', requirement: 20 }
      ],
      headShapes: [
        { id: 'round', name: 'Round', requirement: 0 },
        { id: 'square', name: 'Square', requirement: 3 },
        { id: 'angular', name: 'Angular', requirement: 8 },
        { id: 'triangular', name: 'Triangular', requirement: 15 }
      ],
      hats: [
        { id: '', name: 'None', requirement: 0 },
        { id: 'cap', name: 'Cap', requirement: 4 },
        { id: 'crown', name: 'Crown', requirement: 12 },
        { id: 'helmet', name: 'Helmet', requirement: 18 },
        { id: 'hood', name: 'Hood', requirement: 25 }
      ],
      necklaces: [
        { id: '', name: 'None', requirement: 0 },
        { id: 'chain', name: 'Chain', requirement: 6 },
        { id: 'pendant', name: 'Pendant', requirement: 14 },
        { id: 'medallion', name: 'Medallion', requirement: 22 }
      ],
      armor: [
        { id: '', name: 'None', requirement: 0 },
        { id: 'light', name: 'Light Armor', requirement: 16 },
        { id: 'heavy', name: 'Heavy Armor', requirement: 30 },
        { id: 'tech', name: 'Tech Armor', requirement: 45 }
      ],
      accessories: [
        { id: 'trail', name: 'Speed Trail', requirement: 8 },
        { id: 'aura', name: 'Power Aura', requirement: 40 },
        { id: 'cape', name: 'Cape', requirement: 11 },
        { id: 'visor', name: 'Visor', requirement: 19 }
      ]
    };

    function loadCustomization() {
      const saved = localStorage.getItem('polyrace_customization');
      if (saved) {
        myCustomization = JSON.parse(saved);
      }

      const savedStats = localStorage.getItem('polyrace_stats');
      if (savedStats) {
        playerStats = JSON.parse(savedStats);
      }
    }

    function saveCustomization() {
      localStorage.setItem('polyrace_customization', JSON.stringify(myCustomization));
      localStorage.setItem('polyrace_stats', JSON.stringify(playerStats));
    }

    function isUnlocked(requirement) {
      return playerStats.wins >= requirement;
    }

    // Connect to server
    function initSocket() {
      const serverUrl = window.location.origin;
      socket = io(serverUrl);

      socket.on('connect', () => {
        console.log('Connected to server:', socket.id);
        updateConnectionStatus('connected');
      });

      socket.on('disconnect', () => {
        console.log('Disconnected');
        updateConnectionStatus('disconnected');
        showNotification('Disconnected from server', '#ff0000');
      });

      socket.on('connect_error', () => {
        updateConnectionStatus('disconnected');
      });

      // Player registered
      socket.on('player:registered', (data) => {
        myPlayerId = data.playerId;
        myPlayerName = data.playerData.name;
        document.getElementById('hud-player-name').textContent = myPlayerName;
        console.log('Registered as:', myPlayerName);
      });

      // Players online count update
      socket.on('players:online', (data) => {
        document.getElementById('chat-online-count').textContent = data.count;
      });

      // Chat message received
      socket.on('chat:message', (data) => {
        addChatMessage(data.username, data.message, data.timestamp);
      });

      // Room created
      socket.on('room:created', (data) => {
        currentRoom = data.room;
        showRoomUI(data.room);
      });

      // Room joined
      socket.on('room:joined', (data) => {
        currentRoom = data.room;
        showRoomUI(data.room);
      });

      // Room updated
      socket.on('room:updated', (data) => {
        currentRoom = data.room;
        updateRoomUI(data.room);
      });

      // Match found
      socket.on('match:found', (data) => {
        currentRoom = data.room;
        showRoomUI(data.room);
      });

      // Game countdown
      socket.on('game:countdown', (data) => {
        gameState = 'countdown';
        startCountdown();
      });

      // Game start
      socket.on('game:start', (data) => {
        gameState = 'playing';
        hideDashboard();
        hideRoomUI();
        startGame();
      });

      // Game update (other players)
      socket.on('game:update', (data) => {
        updateOpponentStates(data.players);
      });

      // Game finished
      socket.on('game:finished', (data) => {
        gameState = 'finished';
        showWinner(data.winner);
      });

      // Player left room
      socket.on('room:player-left', (data) => {
        showNotification(`${data.playerName} left the room`, '#ff00ff');
        if (data.room) {
          currentRoom = data.room;
          updateRoomUI(data.room);
        }
      });

      // Room error
      socket.on('room:error', (data) => {
        showNotification(data.message, '#ff0000');
      });
    }

    // =======================================
    // USERNAME & CONNECTION UI
    // =======================================
    function updateConnectionStatus(status) {
      const dot = document.querySelector('.status-dot');
      const text = document.getElementById('connection-text');

      dot.className = `status-dot ${status}`;

      const messages = {
        connected: 'Connected to Railway',
        disconnected: 'Offline',
        connecting: 'Connecting...'
      };

      text.textContent = messages[status] || 'Unknown';
    }

    document.getElementById('username-submit').addEventListener('click', () => {
      const input = document.getElementById('username-input');
      const username = input.value.trim();

      if (username.length < 2) {
        showNotification('Username must be at least 2 characters', '#ff0000');
        return;
      }

      // Save username
      myPlayerName = username;

      // Hide modal
      document.getElementById('username-modal').classList.add('hidden');

      // Show dashboard (no server connection required yet)
      showMainMenu();
    });

    // Allow Enter key to submit
    document.getElementById('username-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('username-submit').click();
      }
    });

    // =======================================
    // ROOM MANAGEMENT
    // =======================================
    function showRoomUI(room) {
      const roomUI = document.getElementById('room-ui');
      roomUI.classList.add('visible');

      document.getElementById('display-room-code').textContent = room.code;
      document.getElementById('hud-room-code').textContent = room.code;
      document.getElementById('game-hud').style.display = 'block';

      updateRoomUI(room);
    }

    function updateRoomUI(room) {
      const playersList = document.getElementById('room-players-list');
      playersList.innerHTML = '';

      room.players.forEach(player => {
        const div = document.createElement('div');
        div.className = 'room-player';
        div.innerHTML = `
          <div class="room-player-name">${player.name}${player.id === myPlayerId ? ' (You)' : ''}</div>
          <div class="room-player-status ${player.ready ? 'ready' : 'waiting'}">
            ${player.ready ? '✓ Ready' : 'Waiting...'}
          </div>
        `;
        playersList.appendChild(div);
      });

      // Update ready button
      const myPlayer = room.players.find(p => p.id === myPlayerId);
      const readyBtn = document.getElementById('ready-btn');

      if (myPlayer && myPlayer.ready) {
        readyBtn.textContent = '✓ READY';
        readyBtn.disabled = true;
      } else {
        readyBtn.textContent = "I'M READY";
        readyBtn.disabled = false;
      }
    }

    function hideRoomUI() {
      document.getElementById('room-ui').classList.remove('visible');
    }

    // Room controls
    document.getElementById('ready-btn').addEventListener('click', () => {
      socket.emit('player:ready');
    });

    document.getElementById('leave-room-btn').addEventListener('click', () => {
      socket.emit('room:leave');
      hideRoomUI();
      currentRoom = null;
      gameState = 'menu';
      showMainMenu();
    });

    // =======================================
    // NOTIFICATIONS
    // =======================================
    function showNotification(message, color) {
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.style.borderColor = color;
      notif.style.color = color;
      notif.style.boxShadow = `0 0 30px ${color}40`;
      notif.textContent = message;
      document.body.appendChild(notif);

      setTimeout(() => {
        notif.style.opacity = '0';
        notif.style.transition = 'all 0.3s ease';
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }

    // =======================================
    // DASHBOARD SYSTEM
    // =======================================
    function showDashboard() {
      document.getElementById('dashboard').classList.add('visible');

      // Update player info
      document.getElementById('dashboard-player-name').textContent = myPlayerName;
      document.getElementById('dashboard-wins').textContent = playerStats.wins;
      document.getElementById('dashboard-games').textContent = playerStats.gamesPlayed;

      // Start player preview animation
      animateDashboardPreview();
    }

    function hideDashboard() {
      document.getElementById('dashboard').classList.remove('visible');
    }

    // Animate player preview in dashboard
    let dashboardPreviewAnimationId = null;
    function animateDashboardPreview() {
      const previewCanvas = document.getElementById('dashboard-player-preview');
      if (!previewCanvas) return;

      const previewCtx = previewCanvas.getContext('2d');
      const centerX = previewCanvas.width / 2;
      const centerY = previewCanvas.height / 2 + 10;

      function animate() {
        previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);

        // Slight breathing animation
        const scale = 1 + Math.sin(Date.now() * 0.001) * 0.05;
        const scaledCenterY = centerY + (1 - scale) * 20;

        // Temporarily use the preview canvas context as the main ctx
        const originalCtx = ctx;
        ctx = previewCtx;

        // Draw the player character (no name or key displayed)
        drawRunner(centerX, scaledCenterY, myCustomization.primaryColor, '', null, true);

        // Restore original ctx
        ctx = originalCtx;

        dashboardPreviewAnimationId = requestAnimationFrame(animate);
      }

      animate();
    }

    // =======================================
    // GLOBAL CHAT SYSTEM
    // =======================================
    function addChatMessage(username, message, timestamp) {
      const messagesContainer = document.getElementById('chat-messages');

      const messageEl = document.createElement('div');
      messageEl.className = 'chat-message';

      const userEl = document.createElement('div');
      userEl.className = 'chat-message-user';
      userEl.textContent = username;

      const textEl = document.createElement('div');
      textEl.className = 'chat-message-text';
      textEl.textContent = message;

      const timeEl = document.createElement('div');
      timeEl.className = 'chat-message-time';
      timeEl.textContent = timestamp || 'Just now';

      messageEl.appendChild(userEl);
      messageEl.appendChild(textEl);
      messageEl.appendChild(timeEl);

      messagesContainer.appendChild(messageEl);

      // Auto-scroll to bottom
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // Keep only last 100 messages
      while (messagesContainer.children.length > 100) {
        messagesContainer.removeChild(messagesContainer.firstChild);
      }
    }

    function initChatHandlers() {
      const chatInput = document.getElementById('chat-input');

      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && chatInput.value.trim()) {
          const message = chatInput.value.trim();

          // Only send if connected to server
          if (socket && socket.connected) {
            socket.emit('chat:send', {
              username: myPlayerName,
              message: message
            });
            chatInput.value = '';
          } else {
            showNotification('Not connected to server', '#ff0000');
            chatInput.value = '';
          }
        }
      });
    }

    // =======================================
    // MAIN MENU (Simple for now)
    // =======================================
    function showMainMenu() {
      showDashboard();
    }

    // Keyboard shortcuts for menu
    document.addEventListener('keypress', (e) => {
      if (gameState === 'menu') {
        if (e.key.toLowerCase() === 'c') {
          socket.emit('room:create');
        } else if (e.key.toLowerCase() === 'j') {
          const code = prompt('Enter room code:');
          if (code) {
            socket.emit('room:join', { roomCode: code.toUpperCase() });
          }
        } else if (e.key.toLowerCase() === 'r') {
          socket.emit('match:random');
          showNotification('Searching for opponent...', '#ff00ff');
        } else if (e.key.toLowerCase() === 'x') {
          showCustomizationModal();
        }
      }
    });

    // =======================================
    // DASHBOARD MENU CARD HANDLERS
    // =======================================
    function initDashboardMenuHandlers() {
      // Local game card (offline practice)
      document.getElementById('menu-local').addEventListener('click', () => {
        hideDashboard();

        // Ask if single or 2-player
        const twoPlayer = confirm('2 PLAYERS (OK) or SOLO PRACTICE (Cancel)?');

        if (twoPlayer) {
          showNotification('Starting 2-player local game...', '#00ff88');
          isLocalMultiplayer = true;
          player2Name = 'Player 2';
        } else {
          showNotification('Starting solo practice...', '#00ff88');
          isLocalMultiplayer = false;
        }

        // Start a local game
        gameState = 'playing';
        setTimeout(() => {
          startGame();
        }, 500);
      });

      // Online multiplayer card
      document.getElementById('menu-multiplayer').addEventListener('click', async () => {
        // Connect to server if not already connected
        if (!socket || !socket.connected) {
          showNotification('Connecting to server...', '#00ffff');
          await connectToServer();
        }

        // Show multiplayer options
        const choice = confirm('CREATE ROOM (OK) or JOIN ROOM (Cancel)?');
        if (choice) {
          // Create room
          if (socket && socket.connected) {
            socket.emit('room:create');
            showNotification('Creating room...', '#00ffff');
          }
        } else {
          // Join room
          const code = prompt('Enter 6-character room code:');
          if (code && code.trim().length === 6) {
            if (socket && socket.connected) {
              socket.emit('room:join', { roomCode: code.toUpperCase().trim() });
              showNotification('Joining room...', '#00ffff');
            }
          } else if (code) {
            showNotification('Invalid room code', '#ff0000');
          }
        }
      });

      // Customize card
      document.getElementById('menu-customize').addEventListener('click', () => {
        showCustomizationModal();
      });

      // Settings card
      document.getElementById('menu-settings').addEventListener('click', () => {
        showNotification('Settings coming soon!', '#ff00ff');
      });

      // How to Play card
      document.getElementById('menu-howtoplay').addEventListener('click', () => {
        showHowToPlay();
      });
    }

    // Connect to server (only when needed for online play)
    async function connectToServer() {
      return new Promise((resolve, reject) => {
        if (socket && socket.connected) {
          resolve();
          return;
        }

        initSocket();

        // Wait for connection
        const timeout = setTimeout(() => {
          showNotification('Connection timeout', '#ff0000');
          reject(new Error('Connection timeout'));
        }, 5000);

        socket.once('connect', () => {
          clearTimeout(timeout);
          // Register player
          socket.emit('player:register', { name: myPlayerName });
          resolve();
        });

        socket.once('connect_error', () => {
          clearTimeout(timeout);
          showNotification('Connection failed', '#ff0000');
          reject(new Error('Connection failed'));
        });
      });
    }

    function showHowToPlay() {
      document.getElementById('howtoplay-modal').classList.add('visible');
    }

    function hideHowToPlay() {
      document.getElementById('howtoplay-modal').classList.remove('visible');
    }

    // =======================================
    // GAME ENGINE
    // =======================================
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    let animationFrame = null;

    // Game variables
    const KEYS = ['a','s','d','f','g','h','j','k','l'];
    const PLAYER1_KEYS = ['a','s','d','f']; // Left side keys for player 1
    const PLAYER2_KEYS = ['j','k','l',';']; // Right side keys for player 2

    let myPosition = 0;
    let myProgress = 0;
    let myScore = 0;
    let myCombo = 0;
    let myNextKey = null;
    let opponentData = null;
    let raceStartTime = 0;

    // Local multiplayer variables
    let isLocalMultiplayer = false;
    let player2Name = 'Player 2';
    let player2Position = 0;
    let player2Progress = 0;
    let player2Score = 0;
    let player2Combo = 0;
    let player2NextKey = null;
    const FINISH_LINE = 0.75; // 75% of screen width

    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }

    function getRandomKey() {
      return KEYS[Math.floor(Math.random() * KEYS.length)];
    }

    function startCountdown() {
      let countdownValue = 3;
      const interval = setInterval(() => {
        if (countdownValue > 0) {
          showNotification(countdownValue.toString(), '#ffffff');
          countdownValue--;
        } else {
          clearInterval(interval);
          showNotification('GO!', '#00ff88');
        }
      }, 1000);
    }

    function startGame() {
      resizeCanvas();

      // Show quit button
      document.getElementById('quit-game-btn').style.display = 'block';

      // Reset game state
      myPosition = canvas.width * 0.1;
      myProgress = 0;
      myScore = 0;
      myCombo = 0;
      myNextKey = isLocalMultiplayer ? getRandomKeyForPlayer(1) : getRandomKey();
      raceStartTime = Date.now();

      // Reset player 2 if local multiplayer
      if (isLocalMultiplayer) {
        player2Position = canvas.width * 0.1;
        player2Progress = 0;
        player2Score = 0;
        player2Combo = 0;
        player2NextKey = getRandomKeyForPlayer(2);
      }

      // Start game loop
      gameLoop();

      // Add keyboard listener
      document.addEventListener('keydown', handleKeyPress);
    }

    function getRandomKeyForPlayer(playerNum) {
      const keySet = playerNum === 1 ? PLAYER1_KEYS : PLAYER2_KEYS;
      return keySet[Math.floor(Math.random() * keySet.length)];
    }

    function handleKeyPress(e) {
      if (gameState !== 'playing') return;

      const key = e.key.toLowerCase();

      // Player 1 handling (ASDF keys)
      if (PLAYER1_KEYS.includes(key)) {
        if (key === myNextKey) {
          // Correct key!
          myPosition += canvas.width * 0.05; // Move forward
          myScore += 10 * (1 + myCombo * 0.1);
          myCombo++;
          myNextKey = isLocalMultiplayer ? getRandomKeyForPlayer(1) : getRandomKey();

          // Calculate progress (0 to 1)
          const startX = canvas.width * 0.1;
          const finishX = canvas.width * FINISH_LINE;
          myProgress = Math.min(1, (myPosition - startX) / (finishX - startX));

          // Send update to server if online
          if (socket && socket.connected && currentRoom) {
            socket.emit('player:update', {
              position: myPosition,
              progress: myProgress,
              score: myScore,
              combo: myCombo
            });
          }

          // Check if finished
          if (myProgress >= 1) {
            finishRace();
          }
        } else {
          // Wrong key
          myCombo = 0;
        }
      }

      // Player 2 handling (JKL; keys) - only in local multiplayer
      if (isLocalMultiplayer && PLAYER2_KEYS.includes(key)) {
        if (key === player2NextKey) {
          // Correct key!
          player2Position += canvas.width * 0.05;
          player2Score += 10 * (1 + player2Combo * 0.1);
          player2Combo++;
          player2NextKey = getRandomKeyForPlayer(2);

          // Calculate progress
          const startX = canvas.width * 0.1;
          const finishX = canvas.width * FINISH_LINE;
          player2Progress = Math.min(1, (player2Position - startX) / (finishX - startX));

          // Check if player 2 finished
          if (player2Progress >= 1) {
            finishLocalRace(2);
          }
        } else {
          // Wrong key
          player2Combo = 0;
        }
      }

      // Handle other keys for non-local multiplayer
      if (!isLocalMultiplayer && KEYS.includes(key) && key === myNextKey) {
        // Original behavior for non-local games
        if (key !== myNextKey && !PLAYER1_KEYS.includes(key)) {
          myCombo = 0;
        }
      }
    }

    function finishRace() {
      gameState = 'finished';
      const raceTime = ((Date.now() - raceStartTime) / 1000).toFixed(1);

      if (socket && socket.connected && currentRoom) {
        socket.emit('player:finished', {
          score: myScore,
          time: raceTime
        });
      }

      document.removeEventListener('keydown', handleKeyPress);

      // Show result for local game
      if (isLocalMultiplayer) {
        setTimeout(() => {
          showLocalWinner(myPlayerName, myScore, player2Name, player2Score);
        }, 500);
      }
    }

    function finishLocalRace(playerNum) {
      gameState = 'finished';
      document.removeEventListener('keydown', handleKeyPress);

      const raceTime = ((Date.now() - raceStartTime) / 1000).toFixed(1);

      setTimeout(() => {
        showLocalWinner(myPlayerName, myScore, player2Name, player2Score);
      }, 500);
    }

    function showLocalWinner(p1Name, p1Score, p2Name, p2Score) {
      // Hide quit button
      document.getElementById('quit-game-btn').style.display = 'none';

      const winner = p1Score >= p2Score ? p1Name : p2Name;
      const winnerScore = Math.max(p1Score, p2Score);

      showNotification(`${winner} WINS with ${Math.floor(winnerScore)} points!`, '#FFD700');

      // Update stats if player 1 won
      if (p1Score >= p2Score) {
        playerStats.wins++;
        playerStats.gamesPlayed++;
      } else {
        playerStats.gamesPlayed++;
      }
      saveCustomization();

      // Return to menu after 3 seconds
      setTimeout(() => {
        gameState = 'menu';
        isLocalMultiplayer = false;
        showMainMenu();
      }, 3000);
    }

    function updateOpponentStates(players) {
      // Find opponent (not me)
      const opponent = players.find(p => p.id !== myPlayerId);
      if (opponent) {
        opponentData = opponent;
      }
    }

    function gameLoop() {
      if (gameState !== 'playing') {
        cancelAnimationFrame(animationFrame);
        return;
      }

      // Clear canvas
      ctx.fillStyle = '#020208';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // Draw grid background
      drawGrid();

      // Draw finish line
      drawFinishLine();

      // Draw my runner
      drawRunner(myPosition, canvas.height * 0.4, '#00ffff', myPlayerName, myNextKey, true);

      // Draw player 2 if local multiplayer
      if (isLocalMultiplayer) {
        drawRunner(player2Position, canvas.height * 0.6, '#ff00ff', player2Name, player2NextKey, false);
      }

      // Draw opponent runner (online multiplayer)
      if (!isLocalMultiplayer && opponentData && currentRoom) {
        const opponentPlayer = currentRoom.players.find(p => p.id !== myPlayerId);
        if (opponentPlayer) {
          const startX = canvas.width * 0.1;
          const finishX = canvas.width * FINISH_LINE;
          const opponentPos = startX + (opponentData.progress * (finishX - startX));

          drawRunner(opponentPos, canvas.height * 0.6, '#ff00ff', opponentPlayer.name, null, false);
        }
      }

      // Draw HUD
      drawGameHUD();

      animationFrame = requestAnimationFrame(gameLoop);
    }

    function drawGrid() {
      ctx.strokeStyle = 'rgba(0, 255, 255, 0.1)';
      ctx.lineWidth = 1;
      const cellSize = 40;

      for (let x = 0; x < canvas.width; x += cellSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }

      for (let y = 0; y < canvas.height; y += cellSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
    }

    function drawFinishLine() {
      const x = canvas.width * FINISH_LINE;

      ctx.save();
      ctx.strokeStyle = '#00ff88';
      ctx.lineWidth = 3;
      ctx.setLineDash([10, 5]);

      ctx.beginPath();
      ctx.moveTo(x, 0);
      ctx.lineTo(x, canvas.height);
      ctx.stroke();

      ctx.setLineDash([]);
      ctx.font = 'bold 20px Orbitron';
      ctx.fillStyle = '#00ff88';
      ctx.textAlign = 'center';
      ctx.shadowColor = '#00ff88';
      ctx.shadowBlur = 20;
      ctx.fillText('FINISH', x, 30);
      ctx.restore();
    }

    function drawRunner(x, y, color, name, nextKey, isMe) {
      const customization = isMe ? myCustomization : getOpponentCustomization();
      const primaryColor = customization.primaryColor;
      const secondaryColor = customization.secondaryColor;
      const skinColor = customization.skinColor || '#ffcc99';

      ctx.save();
      ctx.translate(x, y);

      // Draw cape first (behind character)
      if (customization.cape) {
        drawCape(primaryColor);
      }

      // Draw trail if unlocked
      if (customization.trail) {
        drawTrail(primaryColor);
      }

      // Glow effect
      ctx.shadowColor = primaryColor;
      ctx.shadowBlur = 25;

      // Draw legs with animation
      drawLegs(customization.gender, customization.bodyShape, secondaryColor);

      // Draw body with armor if equipped
      drawDetailedBody(customization.gender, customization.bodyShape, customization.armor, primaryColor, secondaryColor);

      // Draw necklace if equipped
      if (customization.necklace) {
        drawNecklace(customization.necklace, primaryColor);
      }

      // Draw arms
      drawArms(customization.gender, secondaryColor, skinColor);

      // Draw head with detail
      drawDetailedHead(customization.gender, customization.headShape, skinColor, secondaryColor);

      // Draw hat if equipped
      if (customization.hat) {
        drawHat(customization.hat, primaryColor, secondaryColor);
      }

      // Draw visor if equipped
      if (customization.visor) {
        drawVisor(primaryColor);
      }

      ctx.restore();

      // Draw aura if unlocked
      if (customization.aura) {
        drawAura(x, y, primaryColor);
      }

      // Draw name above runner
      ctx.save();
      ctx.font = 'bold 13px Orbitron';
      ctx.fillStyle = primaryColor;
      ctx.textAlign = 'center';
      ctx.shadowColor = primaryColor;
      ctx.shadowBlur = 15;
      ctx.fillText(name, x, y - 80);
      ctx.restore();

      // Draw next key (only for player)
      if (isMe && nextKey) {
        ctx.save();
        ctx.font = 'bold 38px Orbitron';
        ctx.fillStyle = primaryColor;
        ctx.textAlign = 'center';
        ctx.shadowColor = primaryColor;
        ctx.shadowBlur = 30;
        const keyY = y - 110 - Math.sin(Date.now() * 0.005) * 5;
        ctx.fillText(nextKey.toUpperCase(), x, keyY);
        ctx.restore();
      }
    }

    // =======================================
    // DETAILED 3D POLY CHARACTER DRAWING
    // =======================================

    function drawLegs(gender, bodyShape, color) {
      const legAnimation = Math.sin(Date.now() * 0.01) * 4;
      const width = bodyShape === 'bulky' ? 7 : bodyShape === 'slim' ? 4 : 5;

      // Right leg
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(width, 10);
      ctx.lineTo(width + 3, 30 + legAnimation);
      ctx.lineTo(width - 1, 30 + legAnimation);
      ctx.lineTo(width - 2, 10);
      ctx.closePath();
      ctx.fill();

      // Right leg shadow
      ctx.fillStyle = adjustBrightness(color, -30);
      ctx.beginPath();
      ctx.moveTo(width, 10);
      ctx.lineTo(width + 3, 30 + legAnimation);
      ctx.lineTo(width + 1, 30 + legAnimation);
      ctx.closePath();
      ctx.fill();

      // Left leg
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(-width, 10);
      ctx.lineTo(-width - 3, 30 - legAnimation);
      ctx.lineTo(-width + 1, 30 - legAnimation);
      ctx.lineTo(-width + 2, 10);
      ctx.closePath();
      ctx.fill();

      // Left leg highlight
      ctx.fillStyle = adjustBrightness(color, 20);
      ctx.beginPath();
      ctx.moveTo(-width, 10);
      ctx.lineTo(-width + 2, 10);
      ctx.lineTo(-width + 1, 30 - legAnimation);
      ctx.closePath();
      ctx.fill();
    }

    function drawDetailedBody(gender, bodyShape, armor, primaryColor, secondaryColor) {
      let width = 14, height = 24;

      if (bodyShape === 'muscular') { width = 16; height = 26; }
      else if (bodyShape === 'slim') { width = 10; height = 22; }
      else if (bodyShape === 'bulky') { width = 18; height = 28; }

      // Torso main shape
      ctx.fillStyle = secondaryColor;
      ctx.beginPath();
      if (gender === 'female') {
        ctx.moveTo(0, -20);
        ctx.lineTo(width - 2, -15);
        ctx.lineTo(width, 8);
        ctx.lineTo(-width, 8);
        ctx.lineTo(-width + 2, -15);
      } else {
        ctx.moveTo(0, -22);
        ctx.lineTo(width, -18);
        ctx.lineTo(width, 8);
        ctx.lineTo(-width, 8);
        ctx.lineTo(-width, -18);
      }
      ctx.closePath();
      ctx.fill();

      // Torso highlight (3D effect)
      ctx.fillStyle = adjustBrightness(secondaryColor, 30);
      ctx.beginPath();
      ctx.moveTo(0, -20);
      ctx.lineTo(-width, -18);
      ctx.lineTo(-width, 8);
      ctx.lineTo(-width + 4, 8);
      ctx.lineTo(-width + 3, -18);
      ctx.closePath();
      ctx.fill();

      // Chest detail
      ctx.fillStyle = adjustBrightness(secondaryColor, -20);
      ctx.beginPath();
      ctx.arc(0, -6, 6, 0, Math.PI);
      ctx.fill();

      // Draw armor if equipped
      if (armor) {
        drawArmor(armor, primaryColor);
      }
    }

    function drawArmor(armorType, color) {
      ctx.shadowBlur = 15;

      if (armorType === 'light') {
        // Shoulder pads
        ctx.fillStyle = color;
        ctx.fillRect(-16, -18, 6, 8);
        ctx.fillRect(10, -18, 6, 8);

        // Chest plate accent
        ctx.beginPath();
        ctx.moveTo(-8, -10);
        ctx.lineTo(8, -10);
        ctx.lineTo(6, 4);
        ctx.lineTo(-6, 4);
        ctx.closePath();
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.stroke();

      } else if (armorType === 'heavy') {
        // Full chest plate
        ctx.fillStyle = adjustBrightness(color, -10);
        ctx.fillRect(-12, -16, 24, 22);

        ctx.fillStyle = color;
        ctx.fillRect(-10, -14, 20, 18);

        // Shoulder guards
        ctx.beginPath();
        ctx.arc(-14, -16, 5, 0, Math.PI * 2);
        ctx.arc(14, -16, 5, 0, Math.PI * 2);
        ctx.fill();

      } else if (armorType === 'tech') {
        // Tech panels
        ctx.fillStyle = color;
        ctx.strokeStyle = adjustBrightness(color, 40);
        ctx.lineWidth = 2;

        // Left panel
        ctx.fillRect(-12, -14, 8, 16);
        ctx.strokeRect(-12, -14, 8, 16);

        // Right panel
        ctx.fillRect(4, -14, 8, 16);
        ctx.strokeRect(4, -14, 8, 16);

        // Center glow
        ctx.fillStyle = adjustBrightness(color, 60);
        ctx.fillRect(-2, -12, 4, 12);
      }

      ctx.shadowBlur = 25;
    }

    function drawArms(gender, color, skinColor) {
      const armAnimation = Math.sin(Date.now() * 0.012 + Math.PI) * 2;

      // Right arm
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(12, -14);
      ctx.lineTo(18, 0 + armAnimation);
      ctx.lineTo(16, 2 + armAnimation);
      ctx.lineTo(10, -12);
      ctx.closePath();
      ctx.fill();

      // Right hand
      ctx.fillStyle = skinColor;
      ctx.beginPath();
      ctx.ellipse(17, 2 + armAnimation, 3, 2, Math.PI / 6, 0, Math.PI * 2);
      ctx.fill();

      // Left arm
      ctx.fillStyle = adjustBrightness(color, 20);
      ctx.beginPath();
      ctx.moveTo(-12, -14);
      ctx.lineTo(-10, -12);
      ctx.lineTo(-16, 2 - armAnimation);
      ctx.lineTo(-18, 0 - armAnimation);
      ctx.closePath();
      ctx.fill();

      // Left hand
      ctx.fillStyle = adjustBrightness(skinColor, 10);
      ctx.beginPath();
      ctx.ellipse(-17, 2 - armAnimation, 3, 2, -Math.PI / 6, 0, Math.PI * 2);
      ctx.fill();
    }

    function drawDetailedHead(gender, headShape, skinColor, secondaryColor) {
      let headWidth = 10, headHeight = 12;

      // Head base
      ctx.fillStyle = skinColor;

      if (headShape === 'round') {
        ctx.beginPath();
        ctx.ellipse(0, -30, headWidth, headHeight, 0, 0, Math.PI * 2);
        ctx.fill();

      } else if (headShape === 'square') {
        ctx.fillRect(-headWidth, -42, headWidth * 2, headHeight * 2);

      } else if (headShape === 'angular') {
        ctx.beginPath();
        ctx.moveTo(0, -44);
        ctx.lineTo(headWidth, -36);
        ctx.lineTo(headWidth, -20);
        ctx.lineTo(-headWidth, -20);
        ctx.lineTo(-headWidth, -36);
        ctx.closePath();
        ctx.fill();

      } else if (headShape === 'triangular') {
        ctx.beginPath();
        ctx.moveTo(0, -46);
        ctx.lineTo(headWidth + 2, -22);
        ctx.lineTo(-headWidth - 2, -22);
        ctx.closePath();
        ctx.fill();
      }

      // Facial features
      ctx.shadowBlur = 0;

      // Eyes
      ctx.fillStyle = '#fff';
      ctx.beginPath();
      ctx.arc(-4, -32, 2.5, 0, Math.PI * 2);
      ctx.arc(4, -32, 2.5, 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = '#000';
      ctx.beginPath();
      ctx.arc(-4, -32, 1.5, 0, Math.PI * 2);
      ctx.arc(4, -32, 1.5, 0, Math.PI * 2);
      ctx.fill();

      // Mouth
      ctx.strokeStyle = adjustBrightness(skinColor, -30);
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.arc(0, -26, 3, 0, Math.PI);
      ctx.stroke();

      ctx.shadowBlur = 25;
    }

    function drawHat(hatType, primaryColor, secondaryColor) {
      if (hatType === 'cap') {
        ctx.fillStyle = primaryColor;
        ctx.beginPath();
        ctx.ellipse(0, -44, 12, 6, 0, Math.PI, Math.PI * 2);
        ctx.fill();

        // Brim
        ctx.fillRect(-14, -44, 28, 3);

      } else if (hatType === 'crown') {
        ctx.fillStyle = '#FFD700';
        ctx.fillRect(-10, -46, 20, 6);

        // Crown points
        for (let i = -8; i <= 8; i += 8) {
          ctx.beginPath();
          ctx.moveTo(i - 3, -46);
          ctx.lineTo(i, -54);
          ctx.lineTo(i + 3, -46);
          ctx.closePath();
          ctx.fill();
        }

        // Gems
        ctx.fillStyle = '#ff00ff';
        ctx.beginPath();
        ctx.arc(0, -43, 2, 0, Math.PI * 2);
        ctx.fill();

      } else if (hatType === 'helmet') {
        ctx.fillStyle = adjustBrightness(secondaryColor, -20);
        ctx.beginPath();
        ctx.arc(0, -34, 12, 0, Math.PI, true);
        ctx.fill();

        ctx.fillRect(-12, -34, 24, 10);

        // Visor
        ctx.fillStyle = '#333';
        ctx.fillRect(-10, -32, 20, 4);

      } else if (hatType === 'hood') {
        ctx.fillStyle = adjustBrightness(primaryColor, -30);
        ctx.beginPath();
        ctx.ellipse(0, -36, 14, 16, 0, 0, Math.PI, true);
        ctx.fill();

        // Hood shadow
        ctx.fillStyle = adjustBrightness(primaryColor, -50);
        ctx.beginPath();
        ctx.arc(0, -32, 10, 0, Math.PI, true);
        ctx.fill();
      }
    }

    function drawNecklace(necklaceType, color) {
      ctx.shadowBlur = 10;

      if (necklaceType === 'chain') {
        ctx.strokeStyle = adjustBrightness(color, 40);
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(0, -18, 8, 0.3, Math.PI - 0.3);
        ctx.stroke();

      } else if (necklaceType === 'pendant') {
        // Chain
        ctx.strokeStyle = adjustBrightness(color, 40);
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.arc(0, -18, 8, 0.3, Math.PI - 0.3);
        ctx.stroke();

        // Pendant
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.moveTo(0, -8);
        ctx.lineTo(3, -4);
        ctx.lineTo(0, -2);
        ctx.lineTo(-3, -4);
        ctx.closePath();
        ctx.fill();

      } else if (necklaceType === 'medallion') {
        // Chain
        ctx.strokeStyle = '#FFD700';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(0, -18, 8, 0.3, Math.PI - 0.3);
        ctx.stroke();

        // Medallion
        ctx.fillStyle = '#FFD700';
        ctx.beginPath();
        ctx.arc(0, -6, 4, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(0, -6, 2, 0, Math.PI * 2);
        ctx.fill();
      }

      ctx.shadowBlur = 25;
    }

    function drawVisor(color) {
      ctx.fillStyle = adjustBrightness(color, -40);
      ctx.globalAlpha = 0.7;
      ctx.fillRect(-10, -34, 20, 5);
      ctx.globalAlpha = 1;

      // Visor glow
      ctx.strokeStyle = color;
      ctx.lineWidth = 1;
      ctx.strokeRect(-10, -34, 20, 5);
    }

    function drawCape(color) {
      const capeWave = Math.sin(Date.now() * 0.008) * 3;

      ctx.fillStyle = adjustBrightness(color, -40);
      ctx.globalAlpha = 0.8;

      ctx.beginPath();
      ctx.moveTo(-10, -16);
      ctx.lineTo(-12, 8);
      ctx.lineTo(-8 + capeWave, 18);
      ctx.lineTo(-6, 8);
      ctx.closePath();
      ctx.fill();

      ctx.beginPath();
      ctx.moveTo(10, -16);
      ctx.lineTo(12, 8);
      ctx.lineTo(8 - capeWave, 18);
      ctx.lineTo(6, 8);
      ctx.closePath();
      ctx.fill();

      ctx.globalAlpha = 1;
    }

    function drawTrail(color) {
      ctx.globalAlpha = 0.3;
      ctx.fillStyle = color;

      for (let i = 1; i <= 5; i++) {
        ctx.globalAlpha = 0.3 / i;
        ctx.beginPath();
        ctx.arc(-i * 8, 0, 12 - i, 0, Math.PI * 2);
        ctx.fill();
      }

      ctx.globalAlpha = 1;
    }

    function drawAura(x, y, color) {
      ctx.save();
      ctx.globalAlpha = 0.2 + Math.sin(Date.now() * 0.003) * 0.1;
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;

      const radius = 40 + Math.sin(Date.now() * 0.005) * 5;

      ctx.beginPath();
      ctx.arc(x, y, radius, 0, Math.PI * 2);
      ctx.stroke();

      ctx.restore();
    }

    function adjustBrightness(color, amount) {
      // Convert hex to RGB
      const hex = color.replace('#', '');
      let r = parseInt(hex.substring(0, 2), 16);
      let g = parseInt(hex.substring(2, 4), 16);
      let b = parseInt(hex.substring(4, 6), 16);

      // Adjust brightness
      r = Math.max(0, Math.min(255, r + amount));
      g = Math.max(0, Math.min(255, g + amount));
      b = Math.max(0, Math.min(255, b + amount));

      // Convert back to hex
      return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
    }

    function getOpponentCustomization() {
      return opponentCustomization || {
        gender: 'male',
        bodyShape: 'athletic',
        headShape: 'round',
        skinColor: '#ffcc99',
        primaryColor: '#ff00ff',
        secondaryColor: '#8800ff',
        trail: false,
        aura: false,
        cape: false,
        hat: '',
        necklace: '',
        visor: false,
        armor: ''
      };
    }

    function drawGameHUD() {
      ctx.save();
      ctx.font = 'bold 18px Orbitron';
      ctx.textAlign = 'left';

      // My stats (left side)
      ctx.fillStyle = '#00ffff';
      ctx.shadowColor = '#00ffff';
      ctx.shadowBlur = 15;
      ctx.fillText(`${myPlayerName}: ${Math.floor(myScore)}`, 20, canvas.height - 60);
      ctx.fillText(`Combo: x${myCombo}`, 20, canvas.height - 30);

      // Player 2 stats (local multiplayer)
      if (isLocalMultiplayer) {
        ctx.textAlign = 'right';
        ctx.fillStyle = '#ff00ff';
        ctx.shadowColor = '#ff00ff';
        ctx.fillText(`${player2Name}: ${Math.floor(player2Score)}`, canvas.width - 20, canvas.height - 60);
        ctx.fillText(`Combo: x${player2Combo}`, canvas.width - 20, canvas.height - 30);
      }

      // Opponent stats (online multiplayer)
      if (!isLocalMultiplayer && opponentData) {
        ctx.textAlign = 'right';
        ctx.fillStyle = '#ff00ff';
        ctx.shadowColor = '#ff00ff';
        ctx.fillText(`Score: ${opponentData.score || 0}`, canvas.width - 20, canvas.height - 60);
        ctx.fillText(`Combo: x${opponentData.combo || 0}`, canvas.width - 20, canvas.height - 30);
      }

      ctx.restore();
    }

    function showWinner(winner) {
      gameState = 'finished';
      cancelAnimationFrame(animationFrame);
      document.removeEventListener('keydown', handleKeyPress);

      // Draw winner overlay
      ctx.save();
      ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.font = 'bold 60px Orbitron';
      ctx.textAlign = 'center';
      ctx.fillStyle = winner.id === myPlayerId ? '#00ff88' : '#ff00ff';
      ctx.shadowColor = ctx.fillStyle;
      ctx.shadowBlur = 50;
      ctx.fillText(`${winner.name} WINS!`, canvas.width / 2, canvas.height / 2 - 50);

      ctx.font = 'bold 30px Orbitron';
      ctx.fillStyle = '#ffffff';
      ctx.shadowBlur = 20;
      ctx.fillText(`Time: ${winner.time}s | Score: ${winner.score}`, canvas.width / 2, canvas.height / 2 + 20);

      ctx.font = '20px Orbitron';
      ctx.fillStyle = '#00ffff';
      ctx.fillText('Returning to menu in 5 seconds...', canvas.width / 2, canvas.height / 2 + 80);
      ctx.restore();

      setTimeout(() => {
        gameState = 'menu';
        currentRoom = null;
        hideRoomUI();
        showMainMenu();
      }, 5000);

      // Track win
      if (winner.id === myPlayerId) {
        playerStats.wins++;
        playerStats.gamesPlayed++;
        saveCustomization();
        showNotification(`+1 Win! Total: ${playerStats.wins}`, '#00ff88');
      } else {
        playerStats.gamesPlayed++;
        saveCustomization();
      }
    }

    // =======================================
    // CUSTOMIZATION UI
    // =======================================
    let tempCustomization = null;

    function showCustomizationModal() {
      const modal = document.getElementById('customize-modal');
      modal.classList.add('visible');

      // Update stats display
      document.getElementById('wins-display').textContent = playerStats.wins;
      document.getElementById('games-display').textContent = playerStats.gamesPlayed;

      // Copy current customization to temp
      tempCustomization = { ...myCustomization };

      // Populate grids
      populateCustomizationGrids();

      // Start preview animation
      animatePreview();
    }

    function hideCustomizationModal() {
      document.getElementById('customize-modal').classList.remove('visible');
      tempCustomization = null;
    }

    function populateCustomizationGrids() {
      // Gender
      const genderGrid = document.getElementById('gender-grid');
      genderGrid.innerHTML = '';
      UNLOCKABLES.genders.forEach(gender => {
        const unlocked = isUnlocked(gender.requirement);
        const selected = tempCustomization.gender === gender.id;

        const item = document.createElement('div');
        item.className = `customize-item ${unlocked ? '' : 'locked'} ${selected ? 'selected' : ''}`;
        item.innerHTML = `
          <div class="customize-item-name">${gender.name}</div>
          <div class="customize-item-req">${unlocked ? 'Unlocked' : `${gender.requirement} wins`}</div>
        `;

        if (unlocked) {
          item.addEventListener('click', () => {
            tempCustomization.gender = gender.id;
            populateCustomizationGrids();
            updatePreview();
          });
        }

        genderGrid.appendChild(item);
      });

      // Colors
      const colorsGrid = document.getElementById('colors-grid');
      colorsGrid.innerHTML = '';
      UNLOCKABLES.colors.forEach(color => {
        const unlocked = isUnlocked(color.requirement);
        const selected = tempCustomization.primaryColor === color.value;

        const item = document.createElement('div');
        item.className = `customize-item color-item ${unlocked ? '' : 'locked'} ${selected ? 'selected' : ''}`;
        item.innerHTML = `
          <div class="customize-item-icon" style="color: ${color.value}">■</div>
          <div class="customize-item-name">${color.name}</div>
          <div class="customize-item-req">${unlocked ? 'Unlocked' : `${color.requirement} wins`}</div>
        `;

        if (unlocked) {
          item.addEventListener('click', () => {
            tempCustomization.primaryColor = color.value;
            tempCustomization.secondaryColor = adjustBrightness(color.value, -40);
            populateCustomizationGrids();
            updatePreview();
          });
        }

        colorsGrid.appendChild(item);
      });

      // Body Shapes
      const bodyShapesGrid = document.getElementById('body-shapes-grid');
      bodyShapesGrid.innerHTML = '';
      UNLOCKABLES.bodyShapes.forEach(shape => {
        const unlocked = isUnlocked(shape.requirement);
        const selected = tempCustomization.bodyShape === shape.id;

        const item = document.createElement('div');
        item.className = `customize-item ${unlocked ? '' : 'locked'} ${selected ? 'selected' : ''}`;
        item.innerHTML = `
          <div class="customize-item-name">${shape.name}</div>
          <div class="customize-item-req">${unlocked ? 'Unlocked' : `${shape.requirement} wins`}</div>
        `;

        if (unlocked) {
          item.addEventListener('click', () => {
            tempCustomization.bodyShape = shape.id;
            populateCustomizationGrids();
            updatePreview();
          });
        }

        bodyShapesGrid.appendChild(item);
      });

      // Head Shapes
      const headShapesGrid = document.getElementById('head-shapes-grid');
      headShapesGrid.innerHTML = '';
      UNLOCKABLES.headShapes.forEach(shape => {
        const unlocked = isUnlocked(shape.requirement);
        const selected = tempCustomization.headShape === shape.id;

        const item = document.createElement('div');
        item.className = `customize-item ${unlocked ? '' : 'locked'} ${selected ? 'selected' : ''}`;
        item.innerHTML = `
          <div class="customize-item-name">${shape.name}</div>
          <div class="customize-item-req">${unlocked ? 'Unlocked' : `${shape.requirement} wins`}</div>
        `;

        if (unlocked) {
          item.addEventListener('click', () => {
            tempCustomization.headShape = shape.id;
            populateCustomizationGrids();
            updatePreview();
          });
        }

        headShapesGrid.appendChild(item);
      });

      // Hats
      const hatsGrid = document.getElementById('hats-grid');
      hatsGrid.innerHTML = '';
      UNLOCKABLES.hats.forEach(hat => {
        const unlocked = isUnlocked(hat.requirement);
        const selected = tempCustomization.hat === hat.id;

        const item = document.createElement('div');
        item.className = `customize-item ${unlocked ? '' : 'locked'} ${selected ? 'selected' : ''}`;
        item.innerHTML = `
          <div class="customize-item-name">${hat.name}</div>
          <div class="customize-item-req">${unlocked ? 'Unlocked' : `${hat.requirement} wins`}</div>
        `;

        if (unlocked) {
          item.addEventListener('click', () => {
            tempCustomization.hat = hat.id;
            populateCustomizationGrids();
            updatePreview();
          });
        }

        hatsGrid.appendChild(item);
      });

      // Necklaces
      const necklacesGrid = document.getElementById('necklaces-grid');
      necklacesGrid.innerHTML = '';
      UNLOCKABLES.necklaces.forEach(necklace => {
        const unlocked = isUnlocked(necklace.requirement);
        const selected = tempCustomization.necklace === necklace.id;

        const item = document.createElement('div');
        item.className = `customize-item ${unlocked ? '' : 'locked'} ${selected ? 'selected' : ''}`;
        item.innerHTML = `
          <div class="customize-item-name">${necklace.name}</div>
          <div class="customize-item-req">${unlocked ? 'Unlocked' : `${necklace.requirement} wins`}</div>
        `;

        if (unlocked) {
          item.addEventListener('click', () => {
            tempCustomization.necklace = necklace.id;
            populateCustomizationGrids();
            updatePreview();
          });
        }

        necklacesGrid.appendChild(item);
      });

      // Armor
      const armorGrid = document.getElementById('armor-grid');
      armorGrid.innerHTML = '';
      UNLOCKABLES.armor.forEach(armor => {
        const unlocked = isUnlocked(armor.requirement);
        const selected = tempCustomization.armor === armor.id;

        const item = document.createElement('div');
        item.className = `customize-item ${unlocked ? '' : 'locked'} ${selected ? 'selected' : ''}`;
        item.innerHTML = `
          <div class="customize-item-name">${armor.name}</div>
          <div class="customize-item-req">${unlocked ? 'Unlocked' : `${armor.requirement} wins`}</div>
        `;

        if (unlocked) {
          item.addEventListener('click', () => {
            tempCustomization.armor = armor.id;
            populateCustomizationGrids();
            updatePreview();
          });
        }

        armorGrid.appendChild(item);
      });

      // Accessories (Effects)
      const accessoriesGrid = document.getElementById('accessories-grid');
      accessoriesGrid.innerHTML = '';
      UNLOCKABLES.accessories.forEach(accessory => {
        const unlocked = isUnlocked(accessory.requirement);
        const selected = tempCustomization[accessory.id];

        const item = document.createElement('div');
        item.className = `customize-item ${unlocked ? '' : 'locked'} ${selected ? 'selected' : ''}`;
        item.innerHTML = `
          <div class="customize-item-name">${accessory.name}</div>
          <div class="customize-item-req">${unlocked ? (selected ? 'Enabled' : 'Disabled') : `${accessory.requirement} wins`}</div>
        `;

        if (unlocked) {
          item.addEventListener('click', () => {
            tempCustomization[accessory.id] = !tempCustomization[accessory.id];
            populateCustomizationGrids();
            updatePreview();
          });
        }

        accessoriesGrid.appendChild(item);
      });
    }

    let previewAnimationFrame = null;
    function animatePreview() {
      if (!document.getElementById('customize-modal').classList.contains('visible')) {
        cancelAnimationFrame(previewAnimationFrame);
        return;
      }

      updatePreview();
      previewAnimationFrame = requestAnimationFrame(animatePreview);
    }

    function updatePreview() {
      const previewCanvas = document.getElementById('preview-canvas');
      const previewCtx = previewCanvas.getContext('2d');

      previewCtx.fillStyle = '#020208';
      previewCtx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);

      // Save current context and customization
      const savedCtx = ctx;
      const savedCustomization = myCustomization;

      // Temporarily use preview context and temp customization
      ctx = previewCtx;
      myCustomization = tempCustomization;

      // Draw runner in center
      drawRunner(previewCanvas.width / 2, previewCanvas.height / 2 + 10, tempCustomization.color, 'PREVIEW', null, true);

      // Restore
      ctx = savedCtx;
      myCustomization = savedCustomization;
    }

    // Customization modal controls
    document.getElementById('apply-customize-btn').addEventListener('click', () => {
      myCustomization = { ...tempCustomization };
      saveCustomization();
      hideCustomizationModal();
      showNotification('Customization applied!', '#00ff88');
    });

    document.getElementById('close-customize-btn').addEventListener('click', () => {
      hideCustomizationModal();
    });

    // How to Play modal close button
    document.getElementById('close-howtoplay-btn').addEventListener('click', () => {
      hideHowToPlay();
    });

    // Quit button handler
    document.getElementById('quit-game-btn').addEventListener('click', () => {
      // Hide quit button
      document.getElementById('quit-game-btn').style.display = 'none';

      // Stop game
      if (animationFrame) {
        cancelAnimationFrame(animationFrame);
        animationFrame = null;
      }

      // Reset game state
      gameState = 'menu';
      currentRoom = null;

      // Leave room if in online game
      if (socket && socket.connected && currentRoom) {
        socket.emit('room:leave');
      }

      hideRoomUI();

      // Return to dashboard
      showMainMenu();
      showNotification('Returned to menu', '#00ffff');
    });

    // Handle window resize
    window.addEventListener('resize', resizeCanvas);

    // =======================================
    // INITIALIZE
    // =======================================
    window.addEventListener('load', () => {
      loadCustomization();
      // Don't connect to server yet - wait until user chooses online mode
      initChatHandlers();
      initDashboardMenuHandlers();
      document.getElementById('username-input').focus();
    });
  </script>
</body>
</html>
