<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>POLY RACE: Multiplayer Racing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      background: #000;
      font-family: 'Orbitron', sans-serif;
    }

    canvas {
      width: 100vw;
      height: 100vh;
      display: block;
      background: #000;
    }

    /* Username Modal */
    #username-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    #username-modal.hidden {
      display: none;
    }

    .modal-content {
      background: linear-gradient(135deg, #020208, #080010);
      border: 2px solid #00ffff;
      border-radius: 12px;
      padding: 40px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 0 50px rgba(0, 255, 255, 0.5);
      text-align: center;
    }

    .modal-title {
      font-size: 32px;
      color: #00ffff;
      margin-bottom: 10px;
      text-shadow: 0 0 20px #00ffff;
      letter-spacing: 3px;
    }

    .modal-subtitle {
      font-size: 14px;
      color: #ff00ff;
      margin-bottom: 30px;
      letter-spacing: 2px;
    }

    #username-input {
      width: 100%;
      padding: 15px;
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(0, 255, 255, 0.5);
      border-radius: 8px;
      color: #00ffff;
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      text-align: center;
      margin-bottom: 20px;
      outline: none;
      transition: all 0.3s ease;
    }

    #username-input:focus {
      border-color: #00ffff;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
    }

    #username-submit {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(0, 255, 136, 0.3));
      border: 2px solid #00ffff;
      border-radius: 8px;
      color: #00ffff;
      font-family: 'Orbitron', sans-serif;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    #username-submit:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.5), rgba(0, 255, 136, 0.5));
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    #username-submit:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Connection Status */
    #connection-status {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid #00ffff;
      border-radius: 8px;
      padding: 12px 20px;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: #00ffff;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-dot.connected { background: #00ff88; box-shadow: 0 0 10px #00ff88; }
    .status-dot.disconnected { background: #ff0000; box-shadow: 0 0 10px #ff0000; animation: none; }
    .status-dot.connecting { background: #ff00ff; box-shadow: 0 0 10px #ff00ff; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Game HUD */
    #game-hud {
      position: fixed;
      top: 20px;
      left: 20px;
      color: #fff;
      z-index: 100;
      font-size: 14px;
    }

    .hud-item {
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 6px;
      padding: 8px 15px;
      margin-bottom: 8px;
    }

    .hud-label {
      font-size: 10px;
      color: rgba(0, 255, 255, 0.6);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .hud-value {
      font-size: 16px;
      color: #00ffff;
      font-weight: bold;
      text-shadow: 0 0 10px #00ffff;
    }

    /* Room UI */
    #room-ui {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(2, 2, 8, 0.95);
      border: 2px solid #00ffff;
      border-radius: 12px;
      padding: 30px;
      z-index: 500;
      min-width: 400px;
      display: none;
    }

    #room-ui.visible {
      display: block;
    }

    .room-title {
      font-size: 24px;
      color: #00ffff;
      text-align: center;
      margin-bottom: 20px;
      text-shadow: 0 0 20px #00ffff;
      letter-spacing: 2px;
    }

    .room-code {
      background: rgba(0, 255, 255, 0.1);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 6px;
      padding: 15px;
      text-align: center;
      margin-bottom: 20px;
    }

    .room-code-label {
      font-size: 10px;
      color: rgba(0, 255, 255, 0.6);
      margin-bottom: 5px;
    }

    .room-code-value {
      font-size: 28px;
      color: #00ffff;
      font-weight: bold;
      letter-spacing: 4px;
      text-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
    }

    .room-players {
      margin: 20px 0;
    }

    .room-player {
      background: rgba(0, 255, 255, 0.05);
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .room-player-name {
      color: #00ffff;
      font-size: 14px;
      font-weight: bold;
    }

    .room-player-status {
      font-size: 11px;
      padding: 4px 12px;
      border-radius: 4px;
      text-transform: uppercase;
    }

    .room-player-status.ready {
      background: rgba(0, 255, 136, 0.3);
      color: #00ff88;
      border: 1px solid #00ff88;
    }

    .room-player-status.waiting {
      background: rgba(255, 0, 255, 0.3);
      color: #ff00ff;
      border: 1px solid #ff00ff;
    }

    .room-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(0, 255, 136, 0.3));
      border: 2px solid #00ffff;
      border-radius: 8px;
      color: #00ffff;
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-top: 10px;
    }

    .room-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.5), rgba(0, 255, 136, 0.5));
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
    }

    .room-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .room-btn.secondary {
      background: linear-gradient(135deg, rgba(255, 0, 255, 0.2), rgba(138, 0, 255, 0.2));
      border-color: #ff00ff;
      color: #ff00ff;
    }

    .room-btn.secondary:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(255, 0, 255, 0.3), rgba(138, 0, 255, 0.3));
      box-shadow: 0 0 30px rgba(255, 0, 255, 0.4);
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      border: 2px solid;
      border-radius: 8px;
      padding: 15px 30px;
      font-size: 14px;
      font-weight: bold;
      z-index: 10000;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from { transform: translate(-50%, -20px); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }
  </style>
</head>
<body>
  <!-- Username Modal -->
  <div id="username-modal">
    <div class="modal-content">
      <div class="modal-title">POLY RACE</div>
      <div class="modal-subtitle">ENTER YOUR NAME</div>
      <input type="text" id="username-input" placeholder="Your Username" maxlength="15" autocomplete="off">
      <button id="username-submit">START RACING</button>
    </div>
  </div>

  <!-- Connection Status -->
  <div id="connection-status">
    <div class="status-dot connecting"></div>
    <span id="connection-text">Connecting...</span>
  </div>

  <!-- Game HUD -->
  <div id="game-hud" style="display: none;">
    <div class="hud-item">
      <div class="hud-label">Your Name</div>
      <div class="hud-value" id="hud-player-name">---</div>
    </div>
    <div class="hud-item">
      <div class="hud-label">Room Code</div>
      <div class="hud-value" id="hud-room-code">---</div>
    </div>
  </div>

  <!-- Room UI -->
  <div id="room-ui">
    <div class="room-title" id="room-title">WAITING FOR PLAYERS</div>

    <div class="room-code">
      <div class="room-code-label">ROOM CODE</div>
      <div class="room-code-value" id="display-room-code">------</div>
    </div>

    <div class="room-players" id="room-players-list">
      <!-- Players will be added here dynamically -->
    </div>

    <button class="room-btn" id="ready-btn">I'M READY</button>
    <button class="room-btn secondary" id="leave-room-btn">LEAVE ROOM</button>
  </div>

  <canvas id="game-canvas"></canvas>

  <script>
    // =======================================
    // GAME STATE & SOCKET CONNECTION
    // =======================================
    let socket = null;
    let myPlayerId = null;
    let myPlayerName = null;
    let currentRoom = null;
    let gameState = 'menu'; // menu, waiting, countdown, playing, finished

    // Connect to server
    function initSocket() {
      const serverUrl = window.location.origin;
      socket = io(serverUrl);

      socket.on('connect', () => {
        console.log('Connected to server:', socket.id);
        updateConnectionStatus('connected');
      });

      socket.on('disconnect', () => {
        console.log('Disconnected');
        updateConnectionStatus('disconnected');
        showNotification('Disconnected from server', '#ff0000');
      });

      socket.on('connect_error', () => {
        updateConnectionStatus('disconnected');
      });

      // Player registered
      socket.on('player:registered', (data) => {
        myPlayerId = data.playerId;
        myPlayerName = data.playerData.name;
        document.getElementById('hud-player-name').textContent = myPlayerName;
        console.log('Registered as:', myPlayerName);
      });

      // Room created
      socket.on('room:created', (data) => {
        currentRoom = data.room;
        showRoomUI(data.room);
      });

      // Room joined
      socket.on('room:joined', (data) => {
        currentRoom = data.room;
        showRoomUI(data.room);
      });

      // Room updated
      socket.on('room:updated', (data) => {
        currentRoom = data.room;
        updateRoomUI(data.room);
      });

      // Match found
      socket.on('match:found', (data) => {
        currentRoom = data.room;
        showRoomUI(data.room);
      });

      // Game countdown
      socket.on('game:countdown', (data) => {
        gameState = 'countdown';
        startCountdown();
      });

      // Game start
      socket.on('game:start', (data) => {
        gameState = 'playing';
        hideRoomUI();
        startGame();
      });

      // Game update (other players)
      socket.on('game:update', (data) => {
        updateOpponentStates(data.players);
      });

      // Game finished
      socket.on('game:finished', (data) => {
        gameState = 'finished';
        showWinner(data.winner);
      });

      // Player left room
      socket.on('room:player-left', (data) => {
        showNotification(`${data.playerName} left the room`, '#ff00ff');
        if (data.room) {
          currentRoom = data.room;
          updateRoomUI(data.room);
        }
      });

      // Room error
      socket.on('room:error', (data) => {
        showNotification(data.message, '#ff0000');
      });
    }

    // =======================================
    // USERNAME & CONNECTION UI
    // =======================================
    function updateConnectionStatus(status) {
      const dot = document.querySelector('.status-dot');
      const text = document.getElementById('connection-text');

      dot.className = `status-dot ${status}`;

      const messages = {
        connected: 'Connected to Railway',
        disconnected: 'Offline',
        connecting: 'Connecting...'
      };

      text.textContent = messages[status] || 'Unknown';
    }

    document.getElementById('username-submit').addEventListener('click', () => {
      const input = document.getElementById('username-input');
      const username = input.value.trim();

      if (username.length < 2) {
        showNotification('Username must be at least 2 characters', '#ff0000');
        return;
      }

      if (!socket || !socket.connected) {
        showNotification('Not connected to server', '#ff0000');
        return;
      }

      // Register player
      socket.emit('player:register', { name: username });

      // Hide modal
      document.getElementById('username-modal').classList.add('hidden');

      // Show main menu
      showMainMenu();
    });

    // Allow Enter key to submit
    document.getElementById('username-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('username-submit').click();
      }
    });

    // =======================================
    // ROOM MANAGEMENT
    // =======================================
    function showRoomUI(room) {
      const roomUI = document.getElementById('room-ui');
      roomUI.classList.add('visible');

      document.getElementById('display-room-code').textContent = room.code;
      document.getElementById('hud-room-code').textContent = room.code;
      document.getElementById('game-hud').style.display = 'block';

      updateRoomUI(room);
    }

    function updateRoomUI(room) {
      const playersList = document.getElementById('room-players-list');
      playersList.innerHTML = '';

      room.players.forEach(player => {
        const div = document.createElement('div');
        div.className = 'room-player';
        div.innerHTML = `
          <div class="room-player-name">${player.name}${player.id === myPlayerId ? ' (You)' : ''}</div>
          <div class="room-player-status ${player.ready ? 'ready' : 'waiting'}">
            ${player.ready ? '✓ Ready' : 'Waiting...'}
          </div>
        `;
        playersList.appendChild(div);
      });

      // Update ready button
      const myPlayer = room.players.find(p => p.id === myPlayerId);
      const readyBtn = document.getElementById('ready-btn');

      if (myPlayer && myPlayer.ready) {
        readyBtn.textContent = '✓ READY';
        readyBtn.disabled = true;
      } else {
        readyBtn.textContent = "I'M READY";
        readyBtn.disabled = false;
      }
    }

    function hideRoomUI() {
      document.getElementById('room-ui').classList.remove('visible');
    }

    // Room controls
    document.getElementById('ready-btn').addEventListener('click', () => {
      socket.emit('player:ready');
    });

    document.getElementById('leave-room-btn').addEventListener('click', () => {
      socket.emit('room:leave');
      hideRoomUI();
      currentRoom = null;
      gameState = 'menu';
      showMainMenu();
    });

    // =======================================
    // NOTIFICATIONS
    // =======================================
    function showNotification(message, color) {
      const notif = document.createElement('div');
      notif.className = 'notification';
      notif.style.borderColor = color;
      notif.style.color = color;
      notif.style.boxShadow = `0 0 30px ${color}40`;
      notif.textContent = message;
      document.body.appendChild(notif);

      setTimeout(() => {
        notif.style.opacity = '0';
        notif.style.transition = 'all 0.3s ease';
        setTimeout(() => notif.remove(), 300);
      }, 3000);
    }

    // =======================================
    // MAIN MENU (Simple for now)
    // =======================================
    function showMainMenu() {
      // For now, just show notification to use keyboard shortcuts
      showNotification('Press C to create room, J to join, R for random match', '#00ffff');
    }

    // Keyboard shortcuts for menu
    document.addEventListener('keypress', (e) => {
      if (gameState === 'menu') {
        if (e.key.toLowerCase() === 'c') {
          socket.emit('room:create');
        } else if (e.key.toLowerCase() === 'j') {
          const code = prompt('Enter room code:');
          if (code) {
            socket.emit('room:join', { roomCode: code.toUpperCase() });
          }
        } else if (e.key.toLowerCase() === 'r') {
          socket.emit('match:random');
          showNotification('Searching for opponent...', '#ff00ff');
        }
      }
    });

    // =======================================
    // GAME ENGINE (Placeholder - will expand)
    // =======================================
    let countdownValue = 3;

    function startCountdown() {
      countdownValue = 3;
      const interval = setInterval(() => {
        if (countdownValue > 0) {
          showNotification(countdownValue.toString(), '#ffffff');
          countdownValue--;
        } else {
          clearInterval(interval);
          showNotification('GO!', '#00ff88');
        }
      }, 1000);
    }

    function startGame() {
      console.log('Game starting...');
      showNotification('Race started!', '#00ffff');
      // Game loop will be implemented here
    }

    function updateOpponentStates(players) {
      // Update opponent positions
      console.log('Opponents updated:', players);
    }

    function showWinner(winner) {
      showNotification(`${winner.name} WINS! Time: ${winner.time}s`, '#00ff88');
      setTimeout(() => {
        gameState = 'menu';
        currentRoom = null;
        hideRoomUI();
        showMainMenu();
      }, 5000);
    }

    // =======================================
    // INITIALIZE
    // =======================================
    window.addEventListener('load', () => {
      initSocket();
      document.getElementById('username-input').focus();
    });
  </script>
</body>
</html>
