<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POLY RACE - Select Mode</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --cyan: #00ffff;
      --magenta: #ff00ff;
      --gold: #FFD700;
      --void: #000000;
      --dark: #0a0a0f;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: 'Orbitron', sans-serif;
      background: radial-gradient(ellipse at center, #0a0a0f 0%, #000000 100%);
      color: #fff;
      overflow: hidden;
    }

    /* Back to Home Button */
    #back-home {
      position: fixed;
      top: 30px;
      left: 30px;
      padding: 14px 28px;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.8rem;
      font-weight: 700;
      letter-spacing: 3px;
      color: var(--cyan);
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid var(--cyan);
      cursor: pointer;
      text-decoration: none;
      z-index: 1000;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      text-shadow: 0 0 10px var(--cyan);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #back-home:hover {
      background: rgba(0, 255, 255, 0.15);
      box-shadow: 0 0 40px rgba(0, 255, 255, 0.5);
      transform: translateX(-8px);
      border-color: #fff;
      color: #fff;
    }

    #back-home svg {
      width: 16px;
      height: 16px;
      transition: transform 0.3s ease;
    }

    #back-home:hover svg {
      transform: translateX(-4px);
    }

    /* Container */
    .container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }

    /* Title */
    .title {
      font-size: 4rem;
      font-weight: 900;
      letter-spacing: 12px;
      text-transform: uppercase;
      text-shadow:
        0 0 40px var(--cyan),
        0 0 80px var(--cyan),
        0 0 120px rgba(0, 255, 255, 0.3);
      margin-bottom: 1rem;
    }

    .subtitle {
      font-size: 1rem;
      color: rgba(255, 255, 255, 0.5);
      letter-spacing: 4px;
      margin-bottom: 4rem;
      text-transform: uppercase;
    }

    /* Mode Selection Grid */
    .mode-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 30px;
      max-width: 1200px;
      margin-bottom: 40px;
    }

    .mode-card {
      position: relative;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(0, 255, 255, 0.3);
      padding: 40px 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      min-height: 320px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .mode-card:hover {
      border-color: var(--cyan);
      box-shadow: 0 0 40px rgba(0, 255, 255, 0.3);
      transform: translateY(-10px);
    }

    .mode-icon {
      margin-bottom: 25px;
      filter: drop-shadow(0 0 15px currentColor);
    }

    .mode-card.practice .mode-icon { color: var(--cyan); }
    .mode-card.local .mode-icon { color: var(--magenta); }
    .mode-card.online .mode-icon { color: var(--gold); }

    .mode-title {
      font-size: 1.6rem;
      font-weight: 800;
      letter-spacing: 4px;
      margin-bottom: 15px;
      text-shadow: 0 0 20px currentColor;
    }

    .mode-card.practice .mode-title { color: var(--cyan); }
    .mode-card.local .mode-title { color: var(--magenta); }
    .mode-card.online .mode-title { color: var(--gold); }

    .mode-desc {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.6);
      text-align: center;
      line-height: 1.6;
      margin-bottom: 15px;
    }

    .mode-players {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.4);
      letter-spacing: 2px;
      margin-top: auto;
    }

    /* Online Lobby */
    #online-lobby {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, #0a0a0f 0%, #000000 100%);
      z-index: 999;
      padding: 40px;
      overflow-y: auto;
    }

    .lobby-container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
      height: calc(100vh - 80px);
    }

    .lobby-main {
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(0, 255, 255, 0.2);
      padding: 30px;
      backdrop-filter: blur(10px);
      overflow-y: auto;
    }

    .lobby-chat {
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(255, 0, 255, 0.2);
      padding: 30px;
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
    }

    .section-title {
      font-size: 1.8rem;
      font-weight: 800;
      letter-spacing: 6px;
      color: var(--cyan);
      text-shadow: 0 0 20px var(--cyan);
      margin-bottom: 30px;
    }

    .lobby-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 40px;
    }

    .action-btn {
      padding: 20px;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 3px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .action-btn.create {
      border-color: var(--cyan);
      color: var(--cyan);
    }

    .action-btn.join {
      border-color: var(--magenta);
      color: var(--magenta);
    }

    .action-btn:hover {
      box-shadow: 0 0 30px currentColor;
      transform: scale(1.05);
    }

    .room-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .room-card {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(0, 255, 255, 0.2);
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .room-card:hover {
      border-color: var(--cyan);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
    }

    .room-info h3 {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--cyan);
      margin-bottom: 8px;
    }

    .room-info p {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.5);
    }

    .room-join-btn {
      padding: 12px 24px;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 2px;
      background: transparent;
      border: 2px solid var(--cyan);
      color: var(--cyan);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .room-join-btn:hover {
      background: rgba(0, 255, 255, 0.1);
    }

    /* Chat */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 0, 255, 0.2);
    }

    .chat-message {
      margin-bottom: 12px;
      font-size: 0.85rem;
    }

    .chat-message .username {
      color: var(--magenta);
      font-weight: 700;
      margin-right: 8px;
    }

    .chat-message .text {
      color: rgba(255, 255, 255, 0.8);
    }

    .chat-input-container {
      display: flex;
      gap: 10px;
    }

    .chat-input {
      flex: 1;
      padding: 12px 16px;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85rem;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(255, 0, 255, 0.3);
      color: #fff;
      outline: none;
    }

    .chat-input:focus {
      border-color: var(--magenta);
    }

    .chat-send {
      padding: 12px 24px;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 2px;
      background: transparent;
      border: 2px solid var(--magenta);
      color: var(--magenta);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .chat-send:hover {
      background: rgba(255, 0, 255, 0.1);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.95);
      border: 2px solid var(--cyan);
      padding: 40px;
      z-index: 2000;
      min-width: 400px;
      box-shadow: 0 0 60px rgba(0, 255, 255, 0.4);
    }

    .modal.active {
      display: block;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--cyan);
      margin-bottom: 25px;
      letter-spacing: 4px;
      text-shadow: 0 0 20px var(--cyan);
    }

    .modal-input {
      width: 100%;
      padding: 15px;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(0, 255, 255, 0.3);
      color: #fff;
      margin-bottom: 25px;
      outline: none;
    }

    .modal-input:focus {
      border-color: var(--cyan);
    }

    .modal-buttons {
      display: flex;
      gap: 15px;
    }

    .modal-btn {
      flex: 1;
      padding: 15px;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 3px;
      border: 2px solid;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-btn.primary {
      background: transparent;
      border-color: var(--cyan);
      color: var(--cyan);
    }

    .modal-btn.primary:hover {
      background: rgba(0, 255, 255, 0.1);
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.4);
    }

    .modal-btn.secondary {
      background: transparent;
      border-color: rgba(255, 255, 255, 0.3);
      color: rgba(255, 255, 255, 0.7);
    }

    .modal-btn.secondary:hover {
      border-color: rgba(255, 255, 255, 0.5);
    }

    /* Fade overlay */
    #fade-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      opacity: 0;
      pointer-events: none;
      z-index: 9999;
      transition: opacity 0.8s ease-in-out;
    }

    #fade-overlay.active {
      opacity: 1;
      pointer-events: all;
    }

    /* Typing Mode Selection */
    .typing-mode-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      max-width: 1200px;
      margin-bottom: 40px;
    }

    .typing-mode-card {
      position: relative;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(0, 255, 255, 0.3);
      padding: 30px 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      min-height: 220px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .typing-mode-card:hover {
      border-color: var(--cyan);
      box-shadow: 0 0 40px rgba(0, 255, 255, 0.3);
      transform: translateY(-5px);
    }

    .typing-mode-icon {
      font-size: 3rem;
      font-weight: 900;
      color: var(--cyan);
      text-shadow: 0 0 20px var(--cyan);
      margin-bottom: 20px;
      filter: drop-shadow(0 0 15px currentColor);
    }

    .typing-mode-title {
      font-size: 1.2rem;
      font-weight: 800;
      letter-spacing: 3px;
      color: var(--cyan);
      text-shadow: 0 0 15px var(--cyan);
      margin-bottom: 12px;
      text-align: center;
    }

    .typing-mode-desc {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.6);
      text-align: center;
      line-height: 1.5;
    }

    .back-btn {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 32px;
      font-family: 'Orbitron', sans-serif;
      font-size: 0.85rem;
      font-weight: 700;
      letter-spacing: 3px;
      color: var(--cyan);
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid var(--cyan);
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      text-shadow: 0 0 10px var(--cyan);
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 500;
    }

    .back-btn:hover {
      background: rgba(0, 255, 255, 0.15);
      box-shadow: 0 0 40px rgba(0, 255, 255, 0.5);
      transform: translateX(-50%) translateY(-3px);
      border-color: #fff;
      color: #fff;
    }

    .back-btn svg {
      width: 16px;
      height: 16px;
      transition: transform 0.3s ease;
    }

    .back-btn:hover svg {
      transform: translateX(-4px);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
      .mode-grid {
        grid-template-columns: 1fr;
        gap: 20px;
        padding: 0 15px;
      }

      .lobby-container {
        grid-template-columns: 1fr;
        padding: 0 15px;
      }

      .title {
        font-size: 2.5rem;
        letter-spacing: 8px;
      }

      .subtitle {
        font-size: 0.9rem;
      }

      #back-home {
        top: 15px;
        left: 15px;
        padding: 10px 20px;
        font-size: 0.75rem;
      }
    }

    @media (max-width: 768px) {
      html, body {
        overflow-x: hidden;
      }

      .container {
        padding: 30px 15px;
      }

      .title {
        font-size: 2rem;
        letter-spacing: 6px;
      }

      .subtitle {
        font-size: 0.8rem;
        letter-spacing: 3px;
        margin-bottom: 2.5rem;
      }

      .mode-grid {
        gap: 15px;
      }

      .mode-card {
        min-height: 250px;
        padding: 30px 20px;
      }

      .mode-title {
        font-size: 1.3rem;
        letter-spacing: 3px;
      }

      .mode-desc {
        font-size: 0.8rem;
      }

      .typing-mode-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }

      .typing-mode-card {
        min-height: 180px;
        padding: 25px 15px;
      }

      .typing-mode-icon {
        font-size: 2.5rem;
      }

      .typing-mode-title {
        font-size: 1rem;
        letter-spacing: 2px;
      }

      .back-btn {
        bottom: 20px;
        padding: 12px 28px;
        font-size: 0.8rem;
      }

      /* Lobby responsive */
      .lobby-container {
        grid-template-columns: 1fr;
        gap: 15px;
        height: auto;
      }

      .lobby-main, .lobby-chat {
        padding: 20px;
        max-height: none;
      }

      .section-title {
        font-size: 1.4rem;
        letter-spacing: 4px;
        margin-bottom: 20px;
      }

      .lobby-actions {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .action-btn {
        padding: 16px;
        font-size: 0.85rem;
      }

      #connection-status {
        flex-direction: column;
        gap: 8px;
        padding: 10px 15px;
        text-align: center;
      }

      #status-text {
        font-size: 0.8rem;
      }

      #status-detail {
        font-size: 0.65rem;
      }

      #players-online-count {
        font-size: 0.7rem;
      }

      .room-card {
        flex-direction: column;
        gap: 12px;
        padding: 15px;
      }

      .room-join-btn {
        width: 100%;
        padding: 10px 20px;
      }

      /* Modal responsive */
      .modal {
        min-width: 90%;
        max-width: 400px;
        padding: 30px 20px;
      }

      .modal-title {
        font-size: 1.2rem;
        letter-spacing: 3px;
      }

      .modal-input {
        padding: 12px;
        font-size: 0.85rem;
      }

      .modal-buttons {
        flex-direction: column;
        gap: 10px;
      }

      .modal-btn {
        width: 100%;
        padding: 12px;
      }

      /* Chat responsive */
      .chat-messages {
        max-height: 250px;
      }

      .chat-message {
        font-size: 0.8rem;
      }

      .chat-input {
        font-size: 0.8rem;
        padding: 10px 12px;
      }

      .chat-send {
        padding: 10px 18px;
        font-size: 0.8rem;
      }

      /* Players list */
      #players-list {
        max-height: 150px;
      }

      /* Room UI Modal */
      #room-ui {
        min-width: 90% !important;
        max-width: 95% !important;
        padding: 25px 20px !important;
        font-size: 0.9rem;
      }

      #room-ui h2 {
        font-size: 1.5rem !important;
        margin-bottom: 20px !important;
      }

      #invite-link-input {
        font-size: 0.75rem !important;
        padding: 10px 12px !important;
      }

      #copy-link-btn {
        padding: 10px 18px !important;
        font-size: 0.75rem !important;
      }

      #ready-btn {
        padding: 12px 32px !important;
        font-size: 0.85rem !important;
      }

      #leave-room-btn {
        padding: 8px 20px !important;
        font-size: 0.75rem !important;
      }
    }

    @media (max-width: 480px) {
      .title {
        font-size: 1.8rem;
        letter-spacing: 4px;
      }

      .subtitle {
        font-size: 0.7rem;
        letter-spacing: 2px;
      }

      .mode-card {
        min-height: 220px;
        padding: 25px 15px;
      }

      .mode-title {
        font-size: 1.1rem;
        letter-spacing: 2px;
      }

      .mode-desc {
        font-size: 0.75rem;
      }

      .mode-players {
        font-size: 0.7rem;
      }

      .typing-mode-card {
        min-height: 160px;
        padding: 20px 12px;
      }

      .typing-mode-icon {
        font-size: 2rem;
      }

      .typing-mode-title {
        font-size: 0.9rem;
      }

      .typing-mode-desc {
        font-size: 0.7rem;
      }

      #back-home {
        padding: 8px 16px;
        font-size: 0.7rem;
      }

      .section-title {
        font-size: 1.2rem;
        letter-spacing: 3px;
      }

      .action-btn {
        font-size: 0.8rem;
      }

      #room-ui h2 {
        font-size: 1.3rem !important;
      }
    }

    /* Touch-friendly buttons */
    @media (hover: none) and (pointer: coarse) {
      .mode-card, .action-btn, .room-join-btn, .modal-btn, .chat-send {
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
      }

      .mode-card:active {
        transform: scale(0.98);
      }

      .action-btn:active, .modal-btn:active {
        transform: scale(0.96);
      }
    }
  </style>
</head>
<body>
  <div id="fade-overlay"></div>

  <button id="back-home">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
      <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
    <span id="back-text">HOME</span>
  </button>

  <!-- Mode Selection Screen -->
  <div class="container" id="mode-selection">
    <h1 class="title">SELECT MODE</h1>
    <p class="subtitle">Choose your racing experience</p>

    <div class="mode-grid">
      <!-- Practice Mode -->
      <div class="mode-card practice" data-mode="practice">
        <div class="mode-icon">
          <svg width="80" height="80" viewBox="0 0 80 80">
            <g transform="translate(25, 15)">
              <circle cx="15" cy="10" r="5" fill="currentColor" opacity="0.6"/>
              <rect x="12" y="15" width="6" height="12" fill="currentColor" opacity="0.5"/>
              <line x1="15" y1="27" x2="10" y2="38" stroke="currentColor" stroke-width="3" opacity="0.5"/>
              <line x1="15" y1="27" x2="20" y2="38" stroke="currentColor" stroke-width="3" opacity="0.5"/>
              <line x1="12" y1="18" x2="7" y2="28" stroke="currentColor" stroke-width="2.5" opacity="0.5"/>
              <line x1="18" y1="18" x2="23" y2="28" stroke="currentColor" stroke-width="2.5" opacity="0.5"/>
              <line x1="0" y1="20" x2="8" y2="20" stroke="currentColor" stroke-width="1.5" opacity="0.3"/>
              <line x1="2" y1="25" x2="9" y2="25" stroke="currentColor" stroke-width="1.5" opacity="0.3"/>
            </g>
          </svg>
        </div>
        <h2 class="mode-title">PRACTICE</h2>
        <p class="mode-desc">Train alone, improve your typing speed and accuracy at your own pace</p>
        <p class="mode-players">Solo â€¢ No Competition</p>
      </div>

      <!-- Local 1v1 Mode -->
      <div class="mode-card local" data-mode="local">
        <div class="mode-icon">
          <svg width="80" height="80" viewBox="0 0 80 80">
            <g transform="translate(5, 20)">
              <circle cx="10" cy="8" r="4" fill="currentColor" opacity="0.6"/>
              <rect x="8" y="12" width="4" height="10" fill="currentColor" opacity="0.5"/>
              <line x1="10" y1="22" x2="6" y2="32" stroke="currentColor" stroke-width="2.5" opacity="0.5"/>
              <line x1="10" y1="22" x2="14" y2="32" stroke="currentColor" stroke-width="2.5" opacity="0.5"/>
              <line x1="8" y1="15" x2="4" y2="23" stroke="currentColor" stroke-width="2" opacity="0.5"/>
              <line x1="12" y1="15" x2="16" y2="23" stroke="currentColor" stroke-width="2" opacity="0.5"/>
            </g>
            <text x="40" y="45" font-size="12" fill="currentColor" text-anchor="middle" font-weight="900" opacity="0.7">VS</text>
            <g transform="translate(50, 20)">
              <circle cx="10" cy="8" r="4" fill="currentColor" opacity="0.6"/>
              <rect x="8" y="12" width="4" height="10" fill="currentColor" opacity="0.5"/>
              <line x1="10" y1="22" x2="6" y2="32" stroke="currentColor" stroke-width="2.5" opacity="0.5"/>
              <line x1="10" y1="22" x2="14" y2="32" stroke="currentColor" stroke-width="2.5" opacity="0.5"/>
              <line x1="8" y1="15" x2="4" y2="23" stroke="currentColor" stroke-width="2" opacity="0.5"/>
              <line x1="12" y1="15" x2="16" y2="23" stroke="currentColor" stroke-width="2" opacity="0.5"/>
            </g>
          </svg>
        </div>
        <h2 class="mode-title">LOCAL 1v1</h2>
        <p class="mode-desc">Challenge a friend on the same device, split keyboard racing action</p>
        <p class="mode-players">2 Players â€¢ Same Device</p>
      </div>

      <!-- Online Mode -->
      <div class="mode-card online" data-mode="online">
        <div class="mode-icon">
          <svg width="80" height="80" viewBox="0 0 80 80">
            <g transform="translate(10, 30)">
              <circle cx="10" cy="8" r="4" fill="currentColor" opacity="0.6"/>
              <rect x="8" y="12" width="4" height="10" fill="currentColor" opacity="0.5"/>
              <line x1="10" y1="22" x2="6" y2="32" stroke="currentColor" stroke-width="2.5" opacity="0.5"/>
              <line x1="10" y1="22" x2="14" y2="32" stroke="currentColor" stroke-width="2.5" opacity="0.5"/>
              <line x1="8" y1="15" x2="4" y2="23" stroke="currentColor" stroke-width="2" opacity="0.5"/>
              <line x1="12" y1="15" x2="16" y2="23" stroke="currentColor" stroke-width="2" opacity="0.5"/>
            </g>
            <g transform="translate(45, 25)">
              <circle cx="12" cy="15" r="13" fill="none" stroke="currentColor" stroke-width="2" opacity="0.6"/>
              <ellipse cx="12" cy="15" rx="6" ry="13" fill="none" stroke="currentColor" stroke-width="1.5" opacity="0.5"/>
              <line x1="0" y1="15" x2="24" y2="15" stroke="currentColor" stroke-width="1.5" opacity="0.5"/>
              <path d="M 3 8 Q 12 10 21 8" fill="none" stroke="currentColor" stroke-width="1" opacity="0.4"/>
              <path d="M 3 22 Q 12 20 21 22" fill="none" stroke="currentColor" stroke-width="1" opacity="0.4"/>
            </g>
          </svg>
        </div>
        <h2 class="mode-title">ONLINE</h2>
        <p class="mode-desc">Race against players worldwide, create or join rooms, chat and compete</p>
        <p class="mode-players">2-4 Players â€¢ Worldwide</p>
      </div>
    </div>
  </div>

  <!-- Typing Mode Selection Screen -->
  <div class="container" id="typing-mode-selection" style="display: none;">
    <h1 class="title">SELECT TYPING MODE</h1>
    <p class="subtitle" id="selected-game-mode-text">Choose your challenge type</p>

    <div class="typing-mode-grid">
      <div class="typing-mode-card" data-typing-mode="single">
        <div class="typing-mode-icon">A</div>
        <h3 class="typing-mode-title">SINGLE LETTER</h3>
        <p class="typing-mode-desc">Type individual letters as they appear</p>
      </div>

      <div class="typing-mode-card" data-typing-mode="double">
        <div class="typing-mode-icon">AB</div>
        <h3 class="typing-mode-title">DOUBLE LETTER</h3>
        <p class="typing-mode-desc">Type two-letter combinations</p>
      </div>

      <div class="typing-mode-card" data-typing-mode="words">
        <div class="typing-mode-icon">
          <svg width="60" height="60" viewBox="0 0 60 60">
            <text x="30" y="40" text-anchor="middle" font-size="18" fill="currentColor" font-weight="700">WORD</text>
          </svg>
        </div>
        <h3 class="typing-mode-title">WORDS</h3>
        <p class="typing-mode-desc">Type complete words quickly</p>
      </div>

      <div class="typing-mode-card" data-typing-mode="story">
        <div class="typing-mode-icon">
          <svg width="60" height="60" viewBox="0 0 60 60">
            <rect x="15" y="10" width="30" height="40" fill="none" stroke="currentColor" stroke-width="2" opacity="0.6"/>
            <line x1="20" y1="18" x2="40" y2="18" stroke="currentColor" stroke-width="1.5" opacity="0.5"/>
            <line x1="20" y1="25" x2="40" y2="25" stroke="currentColor" stroke-width="1.5" opacity="0.5"/>
            <line x1="20" y1="32" x2="40" y2="32" stroke="currentColor" stroke-width="1.5" opacity="0.5"/>
            <line x1="20" y1="39" x2="35" y2="39" stroke="currentColor" stroke-width="1.5" opacity="0.5"/>
          </svg>
        </div>
        <h3 class="typing-mode-title">STORY MODE</h3>
        <p class="typing-mode-desc">Type sentences and paragraphs</p>
      </div>

      <div class="typing-mode-card" data-typing-mode="custom">
        <div class="typing-mode-icon">
          <svg width="60" height="60" viewBox="0 0 60 60">
            <circle cx="30" cy="30" r="20" fill="none" stroke="currentColor" stroke-width="2" opacity="0.6"/>
            <circle cx="30" cy="15" r="2" fill="currentColor" opacity="0.7"/>
            <circle cx="42" cy="22" r="2" fill="currentColor" opacity="0.7"/>
            <circle cx="42" cy="38" r="2" fill="currentColor" opacity="0.7"/>
            <circle cx="30" cy="45" r="2" fill="currentColor" opacity="0.7"/>
            <circle cx="18" cy="38" r="2" fill="currentColor" opacity="0.7"/>
            <circle cx="18" cy="22" r="2" fill="currentColor" opacity="0.7"/>
          </svg>
        </div>
        <h3 class="typing-mode-title">CUSTOM</h3>
        <p class="typing-mode-desc">Create your own typing challenge</p>
      </div>
    </div>

    <button id="back-to-modes" class="back-btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      BACK
    </button>
  </div>

  <!-- Online Lobby Screen -->
  <div id="online-lobby">
    <div class="lobby-container">
      <!-- Main Lobby Area -->
      <div class="lobby-main">
        <h2 class="section-title">ONLINE LOBBY</h2>

        <!-- Username Section -->
        <div id="username-section" style="margin-bottom: 20px; padding: 15px 20px; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 4px;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <div style="flex: 1;">
              <label style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.5); letter-spacing: 2px; display: block; margin-bottom: 8px;">YOUR USERNAME</label>
              <div style="display: flex; gap: 10px;">
                <input type="text" id="username-input" maxlength="20" placeholder="Enter username..." style="
                  flex: 1;
                  padding: 10px 15px;
                  font-family: 'Orbitron', sans-serif;
                  font-size: 0.9rem;
                  background: rgba(0, 0, 0, 0.6);
                  border: 2px solid rgba(0, 255, 255, 0.3);
                  color: var(--cyan);
                  border-radius: 4px;
                  outline: none;
                  font-weight: 600;
                  letter-spacing: 1px;
                ">
                <button id="change-username-btn" style="
                  padding: 10px 20px;
                  font-family: 'Orbitron', sans-serif;
                  font-size: 0.8rem;
                  font-weight: 600;
                  letter-spacing: 2px;
                  background: transparent;
                  border: 2px solid var(--cyan);
                  color: var(--cyan);
                  cursor: pointer;
                  border-radius: 4px;
                  transition: all 0.3s ease;
                  white-space: nowrap;
                ">CHANGE</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Connection Status -->
        <div id="connection-status" style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding: 12px 20px; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px;">
          <div id="status-indicator" style="width: 12px; height: 12px; border-radius: 50%; background: #FFD700; box-shadow: 0 0 10px currentColor; animation: pulse 2s ease-in-out infinite;"></div>
          <div style="flex: 1;">
            <div id="status-text" style="font-size: 0.85rem; font-weight: 600; letter-spacing: 1px; color: #FFD700;">CONNECTING...</div>
            <div id="status-detail" style="font-size: 0.7rem; color: rgba(255, 255, 255, 0.5); margin-top: 2px;">Establishing connection to server</div>
          </div>
          <div id="players-online-count" style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.6); padding: 4px 12px; background: rgba(255, 255, 255, 0.05); border-radius: 3px;">
            <span style="font-weight: 700; color: var(--cyan);">0</span> online
          </div>
        </div>

        <div class="lobby-actions">
          <button class="action-btn create" id="create-room-btn">
            <svg width="20" height="20" viewBox="0 0 20 20" style="vertical-align: middle; margin-right: 8px;">
              <line x1="10" y1="5" x2="10" y2="15" stroke="currentColor" stroke-width="2"/>
              <line x1="5" y1="10" x2="15" y2="10" stroke="currentColor" stroke-width="2"/>
            </svg>
            CREATE ROOM
          </button>

          <button class="action-btn join" id="join-room-code-btn">
            <svg width="20" height="20" viewBox="0 0 20 20" style="vertical-align: middle; margin-right: 8px;">
              <path d="M 15 10 L 10 5 L 10 8 L 5 8 L 5 12 L 10 12 L 10 15 Z" fill="currentColor"/>
            </svg>
            JOIN WITH CODE
          </button>
        </div>

        <h3 style="color: var(--cyan); font-size: 1.2rem; margin-bottom: 20px; letter-spacing: 3px;">AVAILABLE ROOMS</h3>

        <div class="room-list" id="room-list">
          <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.4);">
            <p>No active rooms. Create one to start racing!</p>
          </div>
        </div>
      </div>

      <!-- Global Chat & Players -->
      <div class="lobby-chat">
        <!-- Online Players Section -->
        <div style="margin-bottom: 20px;">
          <h3 style="color: var(--magenta); font-size: 1.2rem; margin-bottom: 15px; letter-spacing: 3px; display: flex; align-items: center; gap: 10px;">
            ONLINE PLAYERS
            <span id="players-online" style="font-size: 0.9rem; color: var(--cyan); background: rgba(0, 255, 255, 0.1); padding: 4px 10px; border-radius: 3px;">0</span>
          </h3>

          <div id="players-list" style="max-height: 200px; overflow-y: auto; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 0, 255, 0.2); padding: 10px; margin-bottom: 15px;">
            <div style="text-align: center; color: rgba(255, 255, 255, 0.4); padding: 20px; font-size: 0.8rem;">
              Loading players...
            </div>
          </div>
        </div>

        <!-- Chat Section -->
        <h3 style="color: var(--magenta); font-size: 1.2rem; margin-bottom: 15px; letter-spacing: 3px;">GLOBAL CHAT</h3>

        <div class="chat-messages" id="chat-messages">
          <div class="chat-message">
            <span class="username">System:</span>
            <span class="text">Welcome to Poly Race!</span>
          </div>
        </div>

        <div class="chat-input-container">
          <input type="text" class="chat-input" id="chat-input" placeholder="Type your message..." maxlength="200">
          <button class="chat-send" id="chat-send">SEND</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Room Modal -->
  <div class="modal" id="create-room-modal">
    <h2 class="modal-title">CREATE ROOM</h2>
    <p style="font-size: 0.85rem; color: rgba(255,255,255,0.6); margin-bottom: 25px; letter-spacing: 1px;">
      A room will be created with a unique code that you can share with your friend
    </p>
    <div class="modal-buttons">
      <button class="modal-btn primary" id="confirm-create-room">CREATE</button>
      <button class="modal-btn secondary" id="cancel-create-room">CANCEL</button>
    </div>
  </div>

  <!-- Join Room Modal -->
  <div class="modal" id="join-room-modal">
    <h2 class="modal-title">JOIN ROOM</h2>
    <input type="text" class="modal-input" id="room-code-input" placeholder="Enter room code..." maxlength="10">
    <div class="modal-buttons">
      <button class="modal-btn primary" id="confirm-join-room">JOIN</button>
      <button class="modal-btn secondary" id="cancel-join-room">CANCEL</button>
    </div>
  </div>

  <!-- Custom Confirmation Modal -->
  <div class="modal" id="custom-confirm-modal">
    <h2 class="modal-title" id="confirm-title">CONFIRM</h2>
    <p id="confirm-message" style="color: rgba(255,255,255,0.8); font-size: 0.95rem; line-height: 1.6; margin: 20px 0; text-align: center;"></p>
    <div class="modal-buttons">
      <button class="modal-btn primary" id="confirm-yes">YES</button>
      <button class="modal-btn secondary" id="confirm-no">CANCEL</button>
    </div>
  </div>

  <!-- Custom Alert Modal -->
  <div class="modal" id="custom-alert-modal">
    <h2 class="modal-title" id="alert-title">NOTICE</h2>
    <p id="alert-message" style="color: rgba(255,255,255,0.8); font-size: 0.95rem; line-height: 1.6; margin: 20px 0; text-align: center;"></p>
    <div class="modal-buttons">
      <button class="modal-btn primary" id="alert-ok">OK</button>
    </div>
  </div>

  <!-- Load Socket.IO -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <script>
    // State management
    const state = {
      currentMode: null,
      selectedTypingMode: null,
      username: localStorage.getItem('username') || 'Player' + Math.floor(Math.random() * 10000),
      currentRoom: null,
      playerId: null
    };

    // Save username to localStorage
    localStorage.setItem('username', state.username);

    // Check for auto-join from invite link
    window.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const joinCode = urlParams.get('join');

      if (joinCode) {
        console.log('[AUTO-JOIN] Invite link detected. Room code:', joinCode);
        // Auto-open online lobby and attempt to join
        state.currentMode = 'online';
        document.getElementById('mode-selection').style.display = 'none';
        document.getElementById('online-lobby').style.display = 'block';
        connectToLobby();

        // Wait for connection then auto-join
        let attemptCount = 0;
        const maxAttempts = 10;
        const attemptInterval = setInterval(() => {
          attemptCount++;

          if (lobbySocket && lobbySocket.connected && state.playerId) {
            console.log('[AUTO-JOIN] Socket connected! Attempting to join room:', joinCode.toUpperCase());
            clearInterval(attemptInterval);
            lobbySocket.emit('room:join', { roomCode: joinCode.toUpperCase() });
          } else if (attemptCount >= maxAttempts) {
            console.error('[AUTO-JOIN] Failed to connect after', maxAttempts, 'attempts');
            clearInterval(attemptInterval);
            alert('Failed to connect to server. Please try again or check if the room still exists.');
          } else {
            console.log('[AUTO-JOIN] Waiting for connection... Attempt', attemptCount, '/', maxAttempts);
          }
        }, 500);
      }
    });

    // Back button handler
    const backButton = document.getElementById('back-home');
    const backText = document.getElementById('back-text');
    const modeSelection = document.getElementById('mode-selection');
    const typingModeSelection = document.getElementById('typing-mode-selection');
    const onlineLobby = document.getElementById('online-lobby');

    function updateBackButton() {
      // Check if mode selection screen is hidden (meaning we're on a sub-screen)
      if (modeSelection && modeSelection.style.display === 'none') {
        // On any sub-screen (typing mode selection or online lobby) - go back to modes
        backText.textContent = 'MODES';
      } else {
        // On main mode selection screen - go to home
        backText.textContent = 'HOME';
      }
    }

    backButton.addEventListener('click', () => {
      const fadeOverlay = document.getElementById('fade-overlay');

      // Check if we're on the main mode selection screen
      if (modeSelection.style.display === 'none') {
        // We're on a sub-screen, go back to mode selection

        // Disconnect from lobby if in online mode
        if (lobbySocket && lobbySocket.connected) {
          lobbySocket.disconnect();
        }

        fadeOverlay.classList.add('active');
        setTimeout(() => {
          // Hide all sub-screens
          if (typingModeSelection) typingModeSelection.style.display = 'none';
          if (onlineLobby) onlineLobby.style.display = 'none';

          // Show mode selection
          modeSelection.style.display = 'block';

          fadeOverlay.classList.remove('active');
          state.currentRoom = null;
          updateBackButton();
        }, 300);
      } else {
        // We're on mode selection screen, go to home page
        fadeOverlay.classList.add('active');
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 300);
      }
    });

    // Update back button text on page load
    updateBackButton();

    // Mode selection (Practice, Local, Online)
    document.querySelectorAll('.mode-card').forEach(card => {
      card.addEventListener('click', () => {
        const mode = card.dataset.mode;
        state.currentMode = mode;

        if (mode === 'online') {
          document.getElementById('mode-selection').style.display = 'none';
          document.getElementById('online-lobby').style.display = 'block';
          connectToLobby();
          updateBackButton();
        } else {
          document.getElementById('mode-selection').style.display = 'none';
          document.getElementById('typing-mode-selection').style.display = 'flex';

          const modeText = mode === 'practice' ? 'PRACTICE MODE' : 'LOCAL 1v1 MODE';
          document.getElementById('selected-game-mode-text').textContent = modeText;
          updateBackButton();
        }
      });
    });

    // Typing mode selection
    document.querySelectorAll('.typing-mode-card').forEach(card => {
      card.addEventListener('click', () => {
        const typingMode = card.dataset.typingMode;
        state.selectedTypingMode = typingMode;
        proceedToGame();
      });
    });

    function proceedToGame() {
      const fadeOverlay = document.getElementById('fade-overlay');
      const mode = state.currentMode;
      const typingMode = state.selectedTypingMode;

      let gameType = 'letters';
      if (typingMode === 'single') gameType = 'letters';
      else if (typingMode === 'double') gameType = 'double';
      else if (typingMode === 'words') gameType = 'words';
      else if (typingMode === 'story') gameType = 'story';
      else if (typingMode === 'custom') gameType = 'custom';

      if (mode === 'practice') {
        fadeOverlay.classList.add('active');
        setTimeout(() => {
          window.location.href = `game.html?mode=practice&players=1&type=${gameType}&race=quick`;
        }, 800);
      } else if (mode === 'local') {
        fadeOverlay.classList.add('active');
        setTimeout(() => {
          window.location.href = `game.html?mode=local&players=2&type=${gameType}&race=quick`;
        }, 800);
      }
    }

    // Back to game mode selection
    document.getElementById('back-to-modes').addEventListener('click', () => {
      document.getElementById('typing-mode-selection').style.display = 'none';
      document.getElementById('mode-selection').style.display = 'flex';
      state.currentMode = null;
      state.selectedTypingMode = null;
    });

    // Online lobby functionality
    let lobbySocket = null;

    function updateConnectionStatus(status, detail, playerCount = 0) {
      const indicator = document.getElementById('status-indicator');
      const statusText = document.getElementById('status-text');
      const statusDetail = document.getElementById('status-detail');
      const playersCount = document.querySelector('#players-online-count span');

      const colors = {
        connecting: '#FFD700',
        connected: '#00ff88',
        disconnected: '#ff4444',
        error: '#ff4444'
      };

      const texts = {
        connecting: ['CONNECTING...', 'Establishing connection to server'],
        connected: ['CONNECTED', 'Connected to server'],
        disconnected: ['DISCONNECTED', 'Connection lost'],
        error: ['CONNECTION ERROR', 'Failed to connect to server']
      };

      indicator.style.background = colors[status] || '#FFD700';
      indicator.style.boxShadow = `0 0 10px ${colors[status] || '#FFD700'}`;

      statusText.textContent = texts[status][0];
      statusText.style.color = colors[status] || '#FFD700';
      statusDetail.textContent = detail || texts[status][1];

      if (playersCount) {
        playersCount.textContent = playerCount;
      }
    }

    function connectToLobby() {
      updateConnectionStatus('connecting', 'Connecting to server...');

      // Set username in input field
      const usernameInput = document.getElementById('username-input');
      if (usernameInput) {
        usernameInput.value = state.username;
      }

      // PATCH: Always connect to deployed server
      const serverUrl = 'https://polyracer-production.up.railway.app';

      try {
        if (typeof io === 'undefined') {
          updateConnectionStatus('error', 'Socket.IO not loaded');
          return;
        }
        initializeSocket(serverUrl);
      } catch (error) {
        console.error('Failed to connect:', error);
        updateConnectionStatus('error', 'Failed to connect to server');
      }
    }

    // Username change handler
    document.addEventListener('DOMContentLoaded', () => {
      const changeUsernameBtn = document.getElementById('change-username-btn');
      const usernameInput = document.getElementById('username-input');

      if (changeUsernameBtn && usernameInput) {
        changeUsernameBtn.addEventListener('click', () => {
          const newUsername = usernameInput.value.trim();

          if (!newUsername || newUsername.length < 2) {
            alert('Username must be at least 2 characters');
            usernameInput.value = state.username;
            return;
          }

          if (newUsername.length > 20) {
            alert('Username must be 20 characters or less');
            return;
          }

          // Update username
          state.username = newUsername;
          localStorage.setItem('username', newUsername);

          // Update on server if connected
          if (lobbySocket && lobbySocket.connected) {
            lobbySocket.emit('player:update-name', { name: newUsername });
          }

          // Visual feedback
          changeUsernameBtn.textContent = 'CHANGED!';
          changeUsernameBtn.style.borderColor = '#00ff88';
          changeUsernameBtn.style.color = '#00ff88';

          setTimeout(() => {
            changeUsernameBtn.textContent = 'CHANGE';
            changeUsernameBtn.style.borderColor = 'var(--cyan)';
            changeUsernameBtn.style.color = 'var(--cyan)';
          }, 2000);

          console.log('Username changed to:', newUsername);
        });

        // Allow Enter key to change username
        usernameInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            changeUsernameBtn.click();
          }
        });
      }
    });

    function initializeSocket(serverUrl) {
      lobbySocket = io(serverUrl, {
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 5
      });

      lobbySocket.on('connect', () => {
        console.log('Connected to server');
        updateConnectionStatus('connected', `Server: ${serverUrl}`);

        lobbySocket.emit('player:register', {
          name: state.username
        });
      });

      lobbySocket.on('player:registered', (data) => {
        console.log('Player registered:', data);
        state.playerId = data.playerId;

        lobbySocket.emit('players:get');
        lobbySocket.emit('rooms:get');
      });

      lobbySocket.on('players:online', (data) => {
        updateConnectionStatus('connected', `Server: ${serverUrl}`, data.count);
        updatePlayersList(data.players || []);
        console.log(`${data.count} players online`);
      });

      lobbySocket.on('players:list', (data) => {
        updatePlayersList(data.players || []);
      });

      lobbySocket.on('rooms:list', (data) => {
        console.log('Rooms received:', data);
        updateRoomList(data.rooms || []);
      });

      // âœ… Room created handler - consolidated
      lobbySocket.on('room:created', (data) => {
        console.log('Room created:', data);
        state.currentRoom = data.roomCode;

        // Save for later
        localStorage.setItem('roomCode', data.roomCode);
        localStorage.setItem('playerId', state.playerId);
        localStorage.setItem('playerName', state.username);

        // Get room name from data (server sends it at top level)
        const roomName = data.roomName || data.room?.name || state.username + "'s Room";

        // Generate invite link
        const inviteLink = `https://polyracer-production.up.railway.app/modes.html?join=${data.roomCode}`;

        // Auto-share in global chat
        lobbySocket.emit('chat:send', {
          username: state.username,
          message: `ðŸŽ® Room created! Code: ${data.roomCode} | Link: ${inviteLink}`
        });

        // Add system message
        addChatMessage('System', `Room "${roomName}" created with code: ${data.roomCode}`, timestamp());

        // Refresh room list
        lobbySocket.emit('rooms:get');

        // Ask server for room snapshot
        lobbySocket.emit('room:sync:request', { roomCode: data.roomCode });
      });

lobbySocket.on('room:joined', (data) => {
  console.log('Joined room:', data);
  state.currentRoom = data.roomCode;

  // Save info for game session
  localStorage.setItem('roomCode', data.roomCode);
  localStorage.setItem('playerId', state.playerId);
  localStorage.setItem('playerName', state.username);

  addChatMessage('System', `Joined room: ${data.roomCode}`, timestamp());

  // Ask server for latest full state
  lobbySocket.emit('room:sync:request', { roomCode: data.roomCode });
});

// When we receive authoritative room snapshot
lobbySocket.on('room:sync', (data) => {
  console.log('Room sync received:', data.room);
  updateRoomLobbyUI(data.room);
});

// When players toggle ready / leave / join
lobbySocket.on('room:updated', (data) => {
  console.log('Room updated:', data.room);
  updateRoomLobbyUI(data.room);
});

// Game countdown phase (triggered when all ready)
lobbySocket.on('game:countdown', (data) => {
  console.log('Countdown started - all players ready!');
  const lobbyUI = document.getElementById('room-ui');
  if (lobbyUI) {
    lobbyUI.style.display = 'none'; // Hide lobby UI during countdown
  }
  showCountdown(3, () => {
    console.log('Countdown complete');
  });
});

// Game officially starts
lobbySocket.on('game:start', (data) => {
  console.log('Game started for room', data.room.code);
  const fadeOverlay = document.getElementById('fade-overlay');
  fadeOverlay.classList.add('active');
  setTimeout(() => {
    window.location.href = `game.html?mode=online&room=${data.room.code}`;
  }, 800);
});

// --- Error & connection events (unchanged but cleaned) ---
lobbySocket.on('room:error', (data) => {
  console.error('Room error:', data);

  let errorMsg = data.message || 'Room error occurred';

  // Add helpful context for common errors
  if (errorMsg === 'Room not found') {
    errorMsg += '\n\nThe room may have:\nâ€¢ Expired due to inactivity\nâ€¢ Been created on a different server\nâ€¢ Already been deleted\n\nTry creating a new room instead.';
  }

  alert(errorMsg);
});

lobbySocket.on('chat:message', (data) => {
  addChatMessage(data.username, data.message, data.timestamp);
});

lobbySocket.on('disconnect', () => {
  console.log('Disconnected from server');
  updateConnectionStatus('disconnected', 'Connection lost. Attempting to reconnect...');
});

lobbySocket.on('connect_error', (error) => {
  console.error('Connection error:', error);
  updateConnectionStatus('error', `Error: ${error.message || 'Unable to connect'}`);
});

lobbySocket.on('reconnect', (attemptNumber) => {
  console.log('Reconnected after', attemptNumber, 'attempts');
  updateConnectionStatus('connected', 'Reconnected successfully');
});

lobbySocket.on('reconnect_failed', () => {
  updateConnectionStatus('error', 'Failed to reconnect. Please refresh the page.');
});

// Game redirect handler (for future use if needed)
lobbySocket.on('game:redirect', (data) => {
  console.log('Redirecting to game for room:', data.roomCode);
  const fadeOverlay = document.getElementById('fade-overlay');
  fadeOverlay.classList.add('active');
  setTimeout(() => {
    window.location.href = `game.html?mode=online&room=${data.roomCode}`;
  }, 800);
});

    }

    function updateRoomList(rooms) {
      const roomList = document.getElementById('room-list');

      if (!rooms || rooms.length === 0) {
        roomList.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.4);"><p>No active rooms. Create one to start racing!</p></div>';
        return;
      }

      roomList.innerHTML = rooms.map(room => `
        <div class="room-card" onclick="joinRoomByCode('${room.code}')">
          <div class="room-info">
            <h3>${escapeHtml(room.name || 'Room')}</h3>
            <p>Room Code: <strong style="color: var(--cyan); letter-spacing: 2px;">${room.code}</strong> â€¢ ${(room.players && room.players.length) || 0} Players</p>
          </div>
          <button class="room-join-btn">JOIN</button>
        </div>
      `).join('');
    }

    // Modal handling
    document.getElementById('create-room-btn').addEventListener('click', () => {
      document.getElementById('create-room-modal').classList.add('active');
    });

    document.getElementById('join-room-code-btn').addEventListener('click', () => {
      document.getElementById('join-room-modal').classList.add('active');
    });

    document.getElementById('cancel-create-room').addEventListener('click', () => {
      document.getElementById('create-room-modal').classList.remove('active');
    });

    document.getElementById('cancel-join-room').addEventListener('click', () => {
      document.getElementById('join-room-modal').classList.remove('active');
    });

    document.getElementById('confirm-create-room').addEventListener('click', () => {
      if (lobbySocket && lobbySocket.connected) {
        const roomName = `${state.username}'s Room`;

        lobbySocket.emit('room:create', {
          roomName: roomName,
          maxPlayers: 2,
          gameSettings: {
            mode: 'quick',
            typingMode: 'letters'
          }
        });

        console.log('Creating room:', roomName);
      } else {
        alert('Not connected to server');
      }

      document.getElementById('create-room-modal').classList.remove('active');
    });

    document.getElementById('confirm-join-room').addEventListener('click', () => {
      const roomCode = document.getElementById('room-code-input').value.trim().toUpperCase();
      if (!roomCode) {
        alert('Please enter a room code');
        return;
      }

      joinRoomByCode(roomCode);
      document.getElementById('join-room-modal').classList.remove('active');
      document.getElementById('room-code-input').value = '';
    });

    function joinRoomByCode(roomCode) {
      if (lobbySocket && lobbySocket.connected) {
        lobbySocket.emit('room:join', {
          roomCode: roomCode
        });
      } else {
        alert('Not connected to server');
      }
    }

    // Update players list
    function updatePlayersList(players) {
      const playersList = document.getElementById('players-list');
      const playersOnlineCount = document.getElementById('players-online');

      if (!players || players.length === 0) {
        playersList.innerHTML = '<div style="text-align: center; color: rgba(255, 255, 255, 0.4); padding: 20px; font-size: 0.8rem;">No players online</div>';
        playersOnlineCount.textContent = '0';
        return;
      }

      playersOnlineCount.textContent = players.length.toString();

      playersList.innerHTML = players.map(player => {
        const isYou = player.id === state.playerId;
        const statusColor = player.status === 'in-game' ? '#FFD700' : player.status === 'in-room' ? '#ff00ff' : '#00ff88';
        const statusText = player.status === 'in-game' ? 'In Game' : player.status === 'in-room' ? 'In Room' : 'Online';

        return `
          <div style="
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            margin-bottom: 6px;
            background: ${isYou ? 'rgba(0, 255, 255, 0.1)' : 'rgba(255, 255, 255, 0.03)'};
            border: 1px solid ${isYou ? 'rgba(0, 255, 255, 0.3)' : 'rgba(255, 255, 255, 0.1)'};
            border-radius: 4px;
            cursor: ${isYou || player.status !== 'online' ? 'default' : 'pointer'};
            transition: all 0.2s ease;
          "
          ${!isYou && player.status === 'online' ? `onclick="challengePlayer('${player.id}', '${escapeHtml(player.name)}')"` : ''}
          ${!isYou && player.status === 'online' ? `onmouseover="this.style.background='rgba(255, 0, 255, 0.1)'; this.style.borderColor='rgba(255, 0, 255, 0.3)'"` : ''}
          ${!isYou && player.status === 'online' ? `onmouseout="this.style.background='rgba(255, 255, 255, 0.03)'; this.style.borderColor='rgba(255, 255, 255, 0.1)'"` : ''}
          >
            <div style="width: 8px; height: 8px; border-radius: 50%; background: ${statusColor}; box-shadow: 0 0 6px ${statusColor};"></div>

            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 0.85rem; font-weight: 600; color: ${isYou ? 'var(--cyan)' : '#fff'}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${escapeHtml(player.name)}${isYou ? ' (You)' : ''}
              </div>
              <div style="font-size: 0.65rem; color: rgba(255, 255, 255, 0.4); margin-top: 2px;">
                ${statusText} â€¢ ${player.wins || 0} wins â€¢ ${player.gamesPlayed || 0} games
              </div>
            </div>

            ${!isYou && player.status === 'online' ? `
              <div style="font-size: 0.7rem; color: var(--magenta); padding: 4px 8px; background: rgba(255, 0, 255, 0.1); border-radius: 3px; white-space: nowrap;">
                Challenge
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function challengePlayer(playerId, playerName) {
      if (!lobbySocket || !lobbySocket.connected) {
        addChatMessage('System', 'Not connected to server', timestamp());
        return;
      }

      if (confirm(`Challenge ${playerName} to a race?`)) {
        lobbySocket.emit('challenge:send', {
          targetId: playerId
        });
        addChatMessage('System', `Challenge sent to ${playerName}!`, timestamp());
      }
    }

    // Refresh players list every 5 seconds
    setInterval(() => {
      if (lobbySocket && lobbySocket.connected && document.getElementById('online-lobby').style.display === 'block') {
        lobbySocket.emit('players:get');
      }
    }, 5000);

    // Refresh room list every 10 seconds
    setInterval(() => {
      if (lobbySocket && lobbySocket.connected && document.getElementById('online-lobby').style.display === 'block') {
        lobbySocket.emit('rooms:get');
      }
    }, 10000);

    // Chat functionality
    document.getElementById('chat-send').addEventListener('click', sendChatMessage);
    document.getElementById('chat-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendChatMessage();
      }
    });

    function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();

      if (!message) return;

      if (lobbySocket && lobbySocket.connected) {
        lobbySocket.emit('chat:send', {
          username: state.username,
          message: message
        });
      } else {
        addChatMessage('System', 'Not connected to server', timestamp());
      }

      input.value = '';
    }

    function addChatMessage(username, message, timestampVal) {
      const chatMessages = document.getElementById('chat-messages');
      const messageEl = document.createElement('div');
      messageEl.className = 'chat-message';

      const timeStr = timestampVal ?
        `<span style="color: rgba(255, 255, 255, 0.3); font-size: 0.7rem; margin-left: 8px;">${timestampVal}</span>` : '';

      messageEl.innerHTML = `
        <span class="username">${escapeHtml(username)}:</span>
        <span class="text">${linkifyMessage(message)}</span>
        ${timeStr}
      `;
      chatMessages.appendChild(messageEl);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function linkifyMessage(text) {
      // First escape HTML for security
      const escaped = escapeHtml(text);

      // Regex to detect URLs
      const urlRegex = /(https?:\/\/[^\s]+)/g;

      // Replace URLs with clickable links
      return escaped.replace(urlRegex, (url) => {
        return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="
          color: #00ffff;
          text-decoration: underline;
          font-weight: 600;
          cursor: pointer;
          transition: color 0.2s ease;
        " onmouseover="this.style.color='#00ff88'" onmouseout="this.style.color='#00ffff'">${url}</a>`;
      });
    }

    function timestamp() {
      return new Date().toLocaleTimeString('en-US', {
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function updateRoomLobbyUI(room) {
  let lobbyUI = document.getElementById('room-ui');

  // Generate shareable link using production URL
  const inviteLink = `https://polyracer-production.up.railway.app/modes.html?join=${room.code}`;

  if (!lobbyUI) {
    lobbyUI = document.createElement('div');
    lobbyUI.id = 'room-ui';
    lobbyUI.style.position = 'fixed';
    lobbyUI.style.top = '50%';
    lobbyUI.style.left = '50%';
    lobbyUI.style.transform = 'translate(-50%, -50%)';
    lobbyUI.style.background = 'rgba(0,0,0,0.95)';
    lobbyUI.style.border = '2px solid #00ffff';
    lobbyUI.style.padding = '40px';
    lobbyUI.style.borderRadius = '10px';
    lobbyUI.style.textAlign = 'center';
    lobbyUI.style.zIndex = '9999';
    lobbyUI.style.color = '#00ffff';
    lobbyUI.style.minWidth = '500px';
    lobbyUI.style.maxWidth = '90%';
    lobbyUI.style.boxShadow = '0 0 60px rgba(0,255,255,0.4)';
    lobbyUI.innerHTML = `
      <h2 style="letter-spacing:4px; margin-bottom:25px; font-size:2rem; text-shadow:0 0 20px #00ffff;">ROOM ${room.code}</h2>

      <!-- Invite Link Section -->
      <div style="background:rgba(0,0,0,0.6); padding:20px; border:1px solid rgba(0,255,255,0.3); border-radius:8px; margin-bottom:25px;">
        <p style="font-size:0.75rem; letter-spacing:2px; color:rgba(255,255,255,0.6); margin-bottom:12px;">INVITE LINK</p>
        <div style="display:flex; gap:10px; align-items:center;">
          <input type="text" id="invite-link-input" readonly value="${inviteLink}" style="
            flex:1;
            padding:12px 15px;
            background:rgba(0,0,0,0.8);
            border:2px solid rgba(0,255,255,0.4);
            color:#00ffff;
            font-family:'Orbitron';
            font-size:0.85rem;
            border-radius:6px;
            outline:none;
          "/>
          <button id="copy-link-btn" style="
            padding:12px 24px;
            background:transparent;
            border:2px solid #00ffff;
            color:#00ffff;
            font-family:'Orbitron';
            font-weight:600;
            letter-spacing:2px;
            cursor:pointer;
            border-radius:6px;
            transition:all 0.3s ease;
            white-space:nowrap;
          ">COPY</button>
        </div>
        <p style="font-size:0.7rem; color:rgba(255,255,255,0.4); margin-top:10px; letter-spacing:1px;">Share this link with your friend to join instantly</p>
      </div>

      <!-- Players List -->
      <div style="margin-bottom:25px;">
        <p style="font-size:0.75rem; letter-spacing:2px; color:rgba(255,255,255,0.6); margin-bottom:12px;">PLAYERS</p>
        <div id="room-players"></div>
      </div>

      <!-- Ready Button -->
      <button id="ready-btn" style="
        padding:14px 40px;
        border:2px solid #00ff88;
        background:transparent;
        color:#00ff88;
        cursor:pointer;
        font-family:'Orbitron';
        font-weight:700;
        letter-spacing:3px;
        font-size:0.95rem;
        text-transform:uppercase;
        border-radius:6px;
        transition:all 0.3s ease;
        box-shadow:0 0 20px rgba(0,255,136,0.3);
      ">I'M READY</button>

      <!-- Leave Button -->
      <button id="leave-room-btn" style="
        margin-top:15px;
        padding:10px 24px;
        border:2px solid rgba(255,255,255,0.3);
        background:transparent;
        color:rgba(255,255,255,0.6);
        cursor:pointer;
        font-family:'Orbitron';
        font-weight:600;
        letter-spacing:2px;
        font-size:0.8rem;
        text-transform:uppercase;
        border-radius:6px;
        transition:all 0.3s ease;
      ">LEAVE ROOM</button>
    `;
    document.body.appendChild(lobbyUI);

    // Copy button functionality
    document.getElementById('copy-link-btn').addEventListener('click', () => {
      const linkInput = document.getElementById('invite-link-input');
      linkInput.select();
      linkInput.setSelectionRange(0, 99999); // For mobile

      navigator.clipboard.writeText(inviteLink).then(() => {
        const copyBtn = document.getElementById('copy-link-btn');
        const originalText = copyBtn.textContent;
        copyBtn.textContent = 'COPIED!';
        copyBtn.style.borderColor = '#00ff88';
        copyBtn.style.color = '#00ff88';

        setTimeout(() => {
          copyBtn.textContent = originalText;
          copyBtn.style.borderColor = '#00ffff';
          copyBtn.style.color = '#00ffff';
        }, 2000);
      }).catch(err => {
        alert('Failed to copy link. Please copy manually.');
      });
    });

    // Leave room functionality
    document.getElementById('leave-room-btn').addEventListener('click', () => {
      if (confirm('Are you sure you want to leave this room?')) {
        if (lobbySocket && lobbySocket.connected) {
          lobbySocket.emit('room:leave');
        }
        document.body.removeChild(lobbyUI);
        state.currentRoom = null;
      }
    });
  }

  // Update player list
  const playerContainer = document.getElementById('room-players');
  playerContainer.innerHTML = room.players.map(p => `
    <div style="
      margin:10px 0;
      padding:12px 20px;
      font-size:1rem;
      background:rgba(${p.ready ? '0,255,136' : '255,0,255'},0.1);
      border:1px solid rgba(${p.ready ? '0,255,136' : '255,0,255'},0.3);
      border-radius:6px;
      color:${p.ready ? '#00ff88' : '#ff00ff'};
      font-weight:600;
      letter-spacing:2px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    ">
      <span>${escapeHtml(p.name)}</span>
      <span>${p.ready ? 'âœ“ READY' : 'WAITING...'}</span>
    </div>
  `).join('');

  // Ready button
  const readyBtn = document.getElementById('ready-btn');
  readyBtn.onmouseenter = () => {
    readyBtn.style.background = 'rgba(0,255,136,0.1)';
    readyBtn.style.boxShadow = '0 0 30px rgba(0,255,136,0.5)';
  };
  readyBtn.onmouseleave = () => {
    readyBtn.style.background = 'transparent';
    readyBtn.style.boxShadow = '0 0 20px rgba(0,255,136,0.3)';
  };
  readyBtn.onclick = () => {
    lobbySocket.emit('player:ready');
    readyBtn.disabled = true;
    readyBtn.textContent = 'READY âœ“';
    readyBtn.style.opacity = '0.5';
    readyBtn.style.cursor = 'not-allowed';
  };
}

function showCountdown(seconds, callback) {
  const overlay = document.createElement('div');
  overlay.style.position = 'fixed';
  overlay.style.top = '0';
  overlay.style.left = '0';
  overlay.style.width = '100%';
  overlay.style.height = '100%';
  overlay.style.background = 'rgba(0,0,0,0.8)';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.fontSize = '100px';
  overlay.style.fontFamily = 'Orbitron, sans-serif';
  overlay.style.color = '#00ffff';
  overlay.style.textShadow = '0 0 40px #00ffff';
  overlay.style.zIndex = '99999';
  document.body.appendChild(overlay);

  let count = seconds;
  const timer = setInterval(() => {
    overlay.textContent = count > 0 ? count : 'GO!';
    count--;
    if (count < -1) {
      clearInterval(timer);
      document.body.removeChild(overlay);
      if (callback) callback();
    }
  }, 1000);
}

  </script>

  <!-- Global online tracking (for all modes) -->
  <script>
    // Always track users as online on modes page
    (function() {
      const serverUrl = 'https://polyracer-production.up.railway.app';

      // Generate or get stored anonymous ID
      let anonymousId = localStorage.getItem('anonymousId');
      if (!anonymousId) {
        anonymousId = 'Guest_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('anonymousId', anonymousId);
      }

      try {
        const backgroundSocket = io(serverUrl, {
          transports: ['websocket', 'polling'],
          reconnection: true
        });

        backgroundSocket.on('connect', () => {
          console.log('[MODES] Background connection established:', backgroundSocket.id);

          // Register as a visitor
          backgroundSocket.emit('player:register', {
            name: anonymousId,
            isVisitor: true
          });
        });

        backgroundSocket.on('disconnect', () => {
          console.log('[MODES] Background disconnected');
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
          if (backgroundSocket && backgroundSocket.connected) {
            backgroundSocket.disconnect();
          }
        });

      } catch (error) {
        console.error('[MODES] Background connection failed:', error);
      }
    })();
  </script>
</body>
</html>
