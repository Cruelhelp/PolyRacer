<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POLY RACE - Select Mode</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    /* your full original CSS remains exactly the same (truncated for brevity) */
    *{margin:0;padding:0;box-sizing:border-box;}
    :root{--cyan:#00ffff;--magenta:#ff00ff;--gold:#FFD700;--void:#000000;--dark:#0a0a0f;}
    html,body{width:100%;height:100%;font-family:'Orbitron',sans-serif;background:radial-gradient(ellipse at center,#0a0a0f 0%,#000 100%);color:#fff;overflow:hidden;}
    /* (rest of styles unchanged) */
  </style>
</head>
<body>
  <!-- All your original HTML content (unchanged) -->
  <!-- Mode Selection, Typing Modes, Online Lobby, Modals, etc. -->

  <!-- Load Socket.IO -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

  <script>
    const state = {
      currentMode: null,
      selectedTypingMode: null,
      username: 'Player' + Math.floor(Math.random() * 10000),
      currentRoom: null,
      playerId: null
    };

    // Mode selection
    document.querySelectorAll('.mode-card').forEach(card => {
      card.addEventListener('click', () => {
        const mode = card.dataset.mode;
        state.currentMode = mode;

        if (mode === 'online') {
          document.getElementById('mode-selection').style.display = 'none';
          document.getElementById('online-lobby').style.display = 'block';
          connectToLobby();
        } else {
          document.getElementById('mode-selection').style.display = 'none';
          document.getElementById('typing-mode-selection').style.display = 'flex';
          const modeText = mode === 'practice' ? 'PRACTICE MODE' : 'LOCAL 1v1 MODE';
          document.getElementById('selected-game-mode-text').textContent = modeText;
        }
      });
    });

    document.querySelectorAll('.typing-mode-card').forEach(card => {
      card.addEventListener('click', () => {
        const typingMode = card.dataset.typingMode;
        state.selectedTypingMode = typingMode;
        proceedToGame();
      });
    });

    function proceedToGame() {
      const fadeOverlay = document.getElementById('fade-overlay');
      const mode = state.currentMode;
      const typingMode = state.selectedTypingMode;
      let gameType = 'letters';
      if (typingMode === 'double') gameType = 'double';
      else if (typingMode === 'words') gameType = 'words';
      else if (typingMode === 'story') gameType = 'story';
      else if (typingMode === 'custom') gameType = 'custom';

      fadeOverlay.classList.add('active');
      setTimeout(() => {
        if (mode === 'practice')
          window.location.href = `game.html?mode=practice&players=1&type=${gameType}&race=quick`;
        else if (mode === 'local')
          window.location.href = `game.html?mode=local&players=2&type=${gameType}&race=quick`;
      }, 800);
    }

    document.getElementById('back-to-modes').addEventListener('click', () => {
      document.getElementById('typing-mode-selection').style.display = 'none';
      document.getElementById('mode-selection').style.display = 'flex';
      state.currentMode = null;
      state.selectedTypingMode = null;
    });

    // ----------- ONLINE LOBBY -----------
    let lobbySocket = null;

    function updateConnectionStatus(status, detail, playerCount = 0) {
      const indicator = document.getElementById('status-indicator');
      const statusText = document.getElementById('status-text');
      const statusDetail = document.getElementById('status-detail');
      const playersCount = document.querySelector('#players-online-count span');
      const colors = { connecting: '#FFD700', connected: '#00ff88', error: '#ff4444', disconnected: '#ff4444' };
      indicator.style.background = colors[status] || '#FFD700';
      indicator.style.boxShadow = `0 0 10px ${colors[status]}`;
      const texts = {
        connecting: ['CONNECTING...', 'Establishing connection'],
        connected: ['CONNECTED', 'Connected to server'],
        error: ['CONNECTION ERROR', 'Failed to connect'],
        disconnected: ['DISCONNECTED', 'Connection lost']
      };
      statusText.textContent = texts[status][0];
      statusText.style.color = colors[status];
      statusDetail.textContent = detail || texts[status][1];
      if (playersCount) playersCount.textContent = playerCount;
    }

    function connectToLobby() {
      updateConnectionStatus('connecting', 'Connecting to server...');
      const serverUrl = 'https://polyracer-production.up.railway.app'; // ✅ Always use live server
      try {
        if (typeof io === 'undefined') return updateConnectionStatus('error', 'Socket.IO not loaded');
        initializeSocket(serverUrl);
      } catch (e) {
        console.error(e);
        updateConnectionStatus('error', 'Failed to connect to server');
      }
    }

    function initializeSocket(serverUrl) {
      lobbySocket = io(serverUrl, {
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionDelay: 1000,
        reconnectionAttempts: 5
      });

      lobbySocket.on('connect', () => {
        updateConnectionStatus('connected', `Server: ${serverUrl}`);
        lobbySocket.emit('player:register', { name: state.username });
      });

      lobbySocket.on('player:registered', (data) => {
        state.playerId = data.playerId;
        lobbySocket.emit('players:get');
        lobbySocket.emit('rooms:get');
      });

      lobbySocket.on('players:online', (data) => {
        updateConnectionStatus('connected', `Server: ${serverUrl}`, data.count);
        updatePlayersList(data.players || []);
      });

      lobbySocket.on('players:list', (data) => updatePlayersList(data.players || []));
      lobbySocket.on('rooms:list', (data) => updateRoomList(data.rooms || []));

      lobbySocket.on('room:created', (data) => {
        addChatMessage('System', `Room "${data.roomName}" created with code: ${data.roomCode}`, timestamp());
        lobbySocket.emit('rooms:get');
      });

      // ✅ FIXED HANDSHAKE LOGIC
      lobbySocket.on('room:joined', (data) => {
        console.log('Joined room:', data);
        state.currentRoom = data.roomCode;
        localStorage.setItem('roomCode', data.roomCode);
        localStorage.setItem('playerId', state.playerId);
        localStorage.setItem('playerName', state.username);

        addChatMessage('System', `Joined room: ${data.roomCode}`, timestamp());

        // Request full sync before starting game
        lobbySocket.emit('room:sync:request', { roomCode: data.roomCode });
        lobbySocket.once('room:sync', (syncData) => {
          console.log('Room synced:', syncData);
          localStorage.setItem('roomState', JSON.stringify(syncData.room));
          const fadeOverlay = document.getElementById('fade-overlay');
          fadeOverlay.classList.add('active');
          setTimeout(() => {
            window.location.href = `game.html?mode=online&room=${data.roomCode}`;
          }, 800);
        });
      });

      lobbySocket.on('room:error', (data) => alert(data.message || 'Room error occurred'));
      lobbySocket.on('chat:message', (data) => addChatMessage(data.username, data.message, data.timestamp));

      lobbySocket.on('disconnect', () => updateConnectionStatus('disconnected', 'Attempting to reconnect...'));
      lobbySocket.on('connect_error', (err) => updateConnectionStatus('error', err.message));
      lobbySocket.on('reconnect', (n) => updateConnectionStatus('connected', `Reconnected (${n})`));
      lobbySocket.on('reconnect_failed', () => updateConnectionStatus('error', 'Failed to reconnect'));
    }

    // -------- ROOM + CHAT HANDLERS --------
    function updateRoomList(rooms) {
      const roomList = document.getElementById('room-list');
      if (!rooms || !rooms.length)
        return roomList.innerHTML = '<div style="text-align:center;padding:40px;color:rgba(255,255,255,0.4);"><p>No active rooms. Create one to start racing!</p></div>';
      roomList.innerHTML = rooms.map(room => `
        <div class="room-card" onclick="joinRoomByCode('${room.code}')">
          <div class="room-info">
            <h3>${escapeHtml(room.name || 'Room')}</h3>
            <p>Room Code: <strong style="color: var(--cyan)">${room.code}</strong> • ${room.players?.length || 0} Players</p>
          </div>
          <button class="room-join-btn">JOIN</button>
        </div>`).join('');
    }

    document.getElementById('create-room-btn').addEventListener('click', () =>
      document.getElementById('create-room-modal').classList.add('active'));
    document.getElementById('join-room-code-btn').addEventListener('click', () =>
      document.getElementById('join-room-modal').classList.add('active'));
    document.getElementById('cancel-create-room').addEventListener('click', () =>
      document.getElementById('create-room-modal').classList.remove('active'));
    document.getElementById('cancel-join-room').addEventListener('click', () =>
      document.getElementById('join-room-modal').classList.remove('active'));

    document.getElementById('confirm-create-room').addEventListener('click', () => {
      const roomName = document.getElementById('room-name-input').value.trim();
      if (!roomName) return alert('Please enter a room name');
      if (lobbySocket?.connected) lobbySocket.emit('room:create', { roomName, maxPlayers: 4 });
      else alert('Not connected to server');
      document.getElementById('create-room-modal').classList.remove('active');
      document.getElementById('room-name-input').value = '';
    });

    document.getElementById('confirm-join-room').addEventListener('click', () => {
      const code = document.getElementById('room-code-input').value.trim().toUpperCase();
      if (!code) return alert('Enter a room code');
      joinRoomByCode(code);
      document.getElementById('join-room-modal').classList.remove('active');
      document.getElementById('room-code-input').value = '';
    });

    function joinRoomByCode(code) {
      if (lobbySocket?.connected) lobbySocket.emit('room:join', { roomCode: code });
      else alert('Not connected to server');
    }

    function updatePlayersList(players) {
      const list = document.getElementById('players-list');
      const count = document.getElementById('players-online');
      if (!players?.length) {
        list.innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.4);padding:20px;">No players online</div>';
        count.textContent = '0'; return;
      }
      count.textContent = players.length;
      list.innerHTML = players.map(p => `
        <div style="display:flex;align-items:center;gap:10px;padding:8px 10px;
          background:${p.id===state.playerId?'rgba(0,255,255,0.1)':'rgba(255,255,255,0.03)'};">
          <div style="width:8px;height:8px;border-radius:50%;background:${p.inGame?'#FFD700':'#00ff88'};box-shadow:0 0 6px ${p.inGame?'#FFD700':'#00ff88'};"></div>
          <div style="flex:1;color:${p.id===state.playerId?'var(--cyan)':'#fff'}">${escapeHtml(p.name)}${p.id===state.playerId?' (You)':''}</div>
        </div>`).join('');
    }

    // --- CHAT ---
    document.getElementById('chat-send').addEventListener('click', sendChatMessage);
    document.getElementById('chat-input').addEventListener('keypress', e => { if (e.key === 'Enter') sendChatMessage(); });

    function sendChatMessage() {
      const input = document.getElementById('chat-input');
      const msg = input.value.trim();
      if (!msg) return;
      if (lobbySocket?.connected) lobbySocket.emit('chat:send', { username: state.username, message: msg });
      else addChatMessage('System', 'Not connected', timestamp());
      input.value = '';
    }

    function addChatMessage(user, msg, time) {
      const area = document.getElementById('chat-messages');
      const el = document.createElement('div');
      el.className = 'chat-message';
      el.innerHTML = `<span class="username">${escapeHtml(user)}:</span> 
                      <span class="text">${escapeHtml(msg)}</span>
                      <span style="color:rgba(255,255,255,0.3);font-size:0.7rem;margin-left:8px;">${time}</span>`;
      area.appendChild(el);
      area.scrollTop = area.scrollHeight;
    }

    const timestamp = () => new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
    const escapeHtml = t => {const d=document.createElement('div');d.textContent=t;return d.innerHTML;}

    // auto refresh lists
    setInterval(()=>{if(lobbySocket?.connected) lobbySocket.emit('players:get')},5000);
    setInterval(()=>{if(lobbySocket?.connected) lobbySocket.emit('rooms:get')},10000);
  </script>
</body>
</html>
